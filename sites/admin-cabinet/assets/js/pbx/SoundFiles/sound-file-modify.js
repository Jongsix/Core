"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalTranslate, Form, PbxApi, sndPlayer, mergingCheckWorker */
var soundFileModify = {
  trashBin: [],
  $soundUploadButton: $('#upload-sound-file'),
  $soundFileInput: $('#file'),
  $soundFileName: $('#name'),
  $audioPlayer: $('#audio-player'),
  $submitButton: $('#submitbutton'),
  blob: window.URL || window.webkitURL,
  $formObj: $('#sound-file-form'),
  $dropDowns: $('#sound-file-form .dropdown'),
  validateRules: {
    description: {
      identifier: 'name',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.sf_ValidationFileNameIsEmpty
      }]
    },
    path: {
      identifier: 'path',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.sf_ValidationFileNotSelected
      }]
    }
  },
  initialize: function () {
    function initialize() {
      soundFileModify.$dropDowns.dropdown();
      soundFileModify.initializeForm();
      soundFileModify.$soundUploadButton.on('click', function (e) {
        e.preventDefault();
        $('input:file', $(e.target).parents()).click();
      });
      soundFileModify.$soundFileInput.on('change', function (e) {
        var file = e.target.files[0];
        if (file === undefined) return;
        soundFileModify.$soundFileName.val(file.name.replace(/\.[^/.]+$/, ''));
        soundFileModify.blob = window.URL || window.webkitURL;
        var fileURL = soundFileModify.blob.createObjectURL(file);
        sndPlayer.UpdateSource(fileURL);
        PbxApi.FilesUploadFile(file, soundFileModify.cbUploadResumable);
      });
    }

    return initialize;
  }(),

  /**
   * Callback file upload with chunks and merge
   * @param action
   * @param params
   */
  cbUploadResumable: function () {
    function cbUploadResumable(action, params) {
      switch (action) {
        case 'fileSuccess':
          var response = PbxApi.tryParseJSON(params.response);

          if (response !== false && response.data.filename !== undefined) {
            soundFileModify.$soundFileName.val(params.file.fileName);
            soundFileModify.checkStatusFileMerging(params.response);
          } else {
            UserMessage.showMultiString(params, globalTranslate.sf_UploadError);
          }

          break;

        case 'uploadStart':
          soundFileModify.$formObj.addClass('loading');
          break;

        case 'error':
          soundFileModify.$submitButton.removeClass('loading');
          soundFileModify.$formObj.removeClass('loading');
          UserMessage.showMultiString(params, globalTranslate.sf_UploadError);
          break;

        default:
      }
    }

    return cbUploadResumable;
  }(),

  /**
   * Wait for file ready to use
   *
   * @param response ответ функции /pbxcore/api/upload/status
   */
  checkStatusFileMerging: function () {
    function checkStatusFileMerging(response) {
      if (response === undefined || PbxApi.tryParseJSON(response) === false) {
        UserMessage.showMultiString("".concat(globalTranslate.sf_UploadError));
        return;
      }

      var json = JSON.parse(response);

      if (json === undefined || json.data === undefined) {
        UserMessage.showMultiString("".concat(globalTranslate.sf_UploadError));
        return;
      }

      var fileID = json.data.upload_id;
      var filePath = json.data.filename;
      mergingCheckWorker.initialize(fileID, filePath);
    }

    return checkStatusFileMerging;
  }(),

  /**
   * After file converted to MP3 format
   * @param filename
   */
  cbAfterConvertFile: function () {
    function cbAfterConvertFile(filename) {
      if (filename === false) {
        UserMessage.showMultiString("".concat(globalTranslate.sf_UploadError));
      } else {
        soundFileModify.trashBin.push(soundFileModify.$formObj.form('get value', 'path'));
        soundFileModify.$formObj.form('set value', 'path', filename);
        soundFileModify.$soundFileName.trigger('change');
        sndPlayer.UpdateSource("/pbxcore/api/cdr/playback?view=".concat(filename));
        soundFileModify.$submitButton.removeClass('loading');
        soundFileModify.$formObj.removeClass('loading');
      }
    }

    return cbAfterConvertFile;
  }(),
  cbBeforeSendForm: function () {
    function cbBeforeSendForm(settings) {
      var result = settings;
      result.data = soundFileModify.$formObj.form('get values');
      return result;
    }

    return cbBeforeSendForm;
  }(),
  cbAfterSendForm: function () {
    function cbAfterSendForm() {
      soundFileModify.trashBin.forEach(function (filepath) {
        if (filepath) PbxApi.FilesRemoveAudioFile(filepath);
      });
    }

    return cbAfterSendForm;
  }(),
  initializeForm: function () {
    function initializeForm() {
      var category = soundFileModify.$formObj.form('get value', 'category');
      Form.$formObj = soundFileModify.$formObj;
      Form.url = "".concat(globalRootUrl, "sound-files/save");
      Form.validateRules = soundFileModify.validateRules;
      Form.cbBeforeSendForm = soundFileModify.cbBeforeSendForm;
      Form.cbAfterSendForm = soundFileModify.cbAfterSendForm;
      Form.afterSubmitModifyUrl = "".concat(globalRootUrl, "sound-files/modify/").concat(category);
      Form.afterSubmitIndexUrl = "".concat(globalRootUrl, "sound-files/index/#/").concat(category);
      Form.initialize();
    }

    return initializeForm;
  }()
};
$(document).ready(function () {
  soundFileModify.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Tb3VuZEZpbGVzL3NvdW5kLWZpbGUtbW9kaWZ5LmpzIl0sIm5hbWVzIjpbInNvdW5kRmlsZU1vZGlmeSIsInRyYXNoQmluIiwiJHNvdW5kVXBsb2FkQnV0dG9uIiwiJCIsIiRzb3VuZEZpbGVJbnB1dCIsIiRzb3VuZEZpbGVOYW1lIiwiJGF1ZGlvUGxheWVyIiwiJHN1Ym1pdEJ1dHRvbiIsImJsb2IiLCJ3aW5kb3ciLCJVUkwiLCJ3ZWJraXRVUkwiLCIkZm9ybU9iaiIsIiRkcm9wRG93bnMiLCJ2YWxpZGF0ZVJ1bGVzIiwiZGVzY3JpcHRpb24iLCJpZGVudGlmaWVyIiwicnVsZXMiLCJ0eXBlIiwicHJvbXB0IiwiZ2xvYmFsVHJhbnNsYXRlIiwic2ZfVmFsaWRhdGlvbkZpbGVOYW1lSXNFbXB0eSIsInBhdGgiLCJzZl9WYWxpZGF0aW9uRmlsZU5vdFNlbGVjdGVkIiwiaW5pdGlhbGl6ZSIsImRyb3Bkb3duIiwiaW5pdGlhbGl6ZUZvcm0iLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsInRhcmdldCIsInBhcmVudHMiLCJjbGljayIsImZpbGUiLCJmaWxlcyIsInVuZGVmaW5lZCIsInZhbCIsIm5hbWUiLCJyZXBsYWNlIiwiZmlsZVVSTCIsImNyZWF0ZU9iamVjdFVSTCIsInNuZFBsYXllciIsIlVwZGF0ZVNvdXJjZSIsIlBieEFwaSIsIkZpbGVzVXBsb2FkRmlsZSIsImNiVXBsb2FkUmVzdW1hYmxlIiwiYWN0aW9uIiwicGFyYW1zIiwicmVzcG9uc2UiLCJ0cnlQYXJzZUpTT04iLCJkYXRhIiwiZmlsZW5hbWUiLCJmaWxlTmFtZSIsImNoZWNrU3RhdHVzRmlsZU1lcmdpbmciLCJVc2VyTWVzc2FnZSIsInNob3dNdWx0aVN0cmluZyIsInNmX1VwbG9hZEVycm9yIiwiYWRkQ2xhc3MiLCJyZW1vdmVDbGFzcyIsImpzb24iLCJKU09OIiwicGFyc2UiLCJmaWxlSUQiLCJ1cGxvYWRfaWQiLCJmaWxlUGF0aCIsIm1lcmdpbmdDaGVja1dvcmtlciIsImNiQWZ0ZXJDb252ZXJ0RmlsZSIsInB1c2giLCJmb3JtIiwidHJpZ2dlciIsImNiQmVmb3JlU2VuZEZvcm0iLCJzZXR0aW5ncyIsInJlc3VsdCIsImNiQWZ0ZXJTZW5kRm9ybSIsImZvckVhY2giLCJmaWxlcGF0aCIsIkZpbGVzUmVtb3ZlQXVkaW9GaWxlIiwiY2F0ZWdvcnkiLCJGb3JtIiwidXJsIiwiZ2xvYmFsUm9vdFVybCIsImFmdGVyU3VibWl0TW9kaWZ5VXJsIiwiYWZ0ZXJTdWJtaXRJbmRleFVybCIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWtCQTtBQUdBLElBQU1BLGVBQWUsR0FBRztBQUN2QkMsRUFBQUEsUUFBUSxFQUFFLEVBRGE7QUFFdkJDLEVBQUFBLGtCQUFrQixFQUFFQyxDQUFDLENBQUMsb0JBQUQsQ0FGRTtBQUd2QkMsRUFBQUEsZUFBZSxFQUFFRCxDQUFDLENBQUMsT0FBRCxDQUhLO0FBSXZCRSxFQUFBQSxjQUFjLEVBQUVGLENBQUMsQ0FBQyxPQUFELENBSk07QUFLdkJHLEVBQUFBLFlBQVksRUFBRUgsQ0FBQyxDQUFDLGVBQUQsQ0FMUTtBQU12QkksRUFBQUEsYUFBYSxFQUFFSixDQUFDLENBQUMsZUFBRCxDQU5PO0FBT3ZCSyxFQUFBQSxJQUFJLEVBQUVDLE1BQU0sQ0FBQ0MsR0FBUCxJQUFjRCxNQUFNLENBQUNFLFNBUEo7QUFRdkJDLEVBQUFBLFFBQVEsRUFBRVQsQ0FBQyxDQUFDLGtCQUFELENBUlk7QUFTdkJVLEVBQUFBLFVBQVUsRUFBRVYsQ0FBQyxDQUFDLDRCQUFELENBVFU7QUFVdkJXLEVBQUFBLGFBQWEsRUFBRTtBQUNkQyxJQUFBQSxXQUFXLEVBQUU7QUFDWkMsTUFBQUEsVUFBVSxFQUFFLE1BREE7QUFFWkMsTUFBQUEsS0FBSyxFQUFFLENBQ047QUFDQ0MsUUFBQUEsSUFBSSxFQUFFLE9BRFA7QUFFQ0MsUUFBQUEsTUFBTSxFQUFFQyxlQUFlLENBQUNDO0FBRnpCLE9BRE07QUFGSyxLQURD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QWQ7QUFDQUYsTUFBQUEsSUFBSSxDQUFDaEUsYUFBTCxHQUFxQmQsZUFBZSxDQUFDYyxhQUFyQztBQUNBZ0UsTUFBQUEsSUFBSSxDQUFDUixnQkFBTCxHQUF3QnRFLGVBQWUsQ0FBQ3NFLGdCQUF4QztBQUNBUSxNQUFBQSxJQUFJLENBQUNMLGVBQUwsR0FBdUJ6RSxlQUFlLENBQUN5RSxlQUF2QztBQUNBSyxNQUFBQSxJQUFJLENBQUNHLG9CQUFMLGFBQStCRCxhQUEvQixnQ0FBa0VILFFBQWxFO0FBQ0FDLE1BQUFBLElBQUksQ0FBQ0ksbUJBQUwsYUFBOEJGLGFBQTlCLGlDQUFrRUgsUUFBbEU7QUFDQUMsTUFBQUEsSUFBSSxDQUFDdEQsVUFBTDtBQUNBOztBQXhJc0I7QUFBQTtBQUFBLENBQXhCO0FBNElBckIsQ0FBQyxDQUFDZ0YsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUN2QnBGLEVBQUFBLGVBQWUsQ0FBQ3dCLFVBQWhCO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTctMjAyMCBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgZ2xvYmFsVHJhbnNsYXRlLCBGb3JtLCBQYnhBcGksIHNuZFBsYXllciwgbWVyZ2luZ0NoZWNrV29ya2VyICovXG5cblxuY29uc3Qgc291bmRGaWxlTW9kaWZ5ID0ge1xuXHR0cmFzaEJpbjogW10sXG5cdCRzb3VuZFVwbG9hZEJ1dHRvbjogJCgnI3VwbG9hZC1zb3VuZC1maWxlJyksXG5cdCRzb3VuZEZpbGVJbnB1dDogJCgnI2ZpbGUnKSxcblx0JHNvdW5kRmlsZU5hbWU6ICQoJyNuYW1lJyksXG5cdCRhdWRpb1BsYXllcjogJCgnI2F1ZGlvLXBsYXllcicpLFxuXHQkc3VibWl0QnV0dG9uOiAkKCcjc3VibWl0YnV0dG9uJyksXG5cdGJsb2I6IHdpbmRvdy5VUkwgfHwgd2luZG93LndlYmtpdFVSTCxcblx0JGZvcm1PYmo6ICQoJyNzb3VuZC1maWxlLWZvcm0nKSxcblx0JGRyb3BEb3duczogJCgnI3NvdW5kLWZpbGUtZm9ybSAuZHJvcGRvd24nKSxcblx0dmFsaWRhdGVSdWxlczoge1xuXHRcdGRlc2NyaXB0aW9uOiB7XG5cdFx0XHRpZGVudGlmaWVyOiAnbmFtZScsXG5cdFx0XHRydWxlczogW1xuXHRcdFx0XHR7XG5cdFx0XHRcdFx0dHlwZTogJ2VtcHR5Jyxcblx0XHRcdFx0XHRwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5zZl9WYWxpZGF0aW9uRmlsZU5hbWVJc0VtcHR5LFxuXHRcdFx0XHR9LFxuXHRcdFx0XSxcblx0XHR9LFxuXHRcdHBhdGg6IHtcblx0XHRcdGlkZW50aWZpZXI6ICdwYXRoJyxcblx0XHRcdHJ1bGVzOiBbXG5cdFx0XHRcdHtcblx0XHRcdFx0XHR0eXBlOiAnZW1wdHknLFxuXHRcdFx0XHRcdHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLnNmX1ZhbGlkYXRpb25GaWxlTm90U2VsZWN0ZWQsXG5cdFx0XHRcdH0sXG5cdFx0XHRdLFxuXHRcdH0sXG5cdH0sXG5cdGluaXRpYWxpemUoKSB7XG5cdFx0c291bmRGaWxlTW9kaWZ5LiRkcm9wRG93bnMuZHJvcGRvd24oKTtcblx0XHRzb3VuZEZpbGVNb2RpZnkuaW5pdGlhbGl6ZUZvcm0oKTtcblxuXHRcdHNvdW5kRmlsZU1vZGlmeS4kc291bmRVcGxvYWRCdXR0b24ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdCQoJ2lucHV0OmZpbGUnLCAkKGUudGFyZ2V0KS5wYXJlbnRzKCkpLmNsaWNrKCk7XG5cdFx0fSk7XG5cblx0XHRzb3VuZEZpbGVNb2RpZnkuJHNvdW5kRmlsZUlucHV0Lm9uKCdjaGFuZ2UnLCAoZSkgPT4ge1xuXHRcdFx0Y29uc3QgZmlsZSA9IGUudGFyZ2V0LmZpbGVzWzBdO1xuXHRcdFx0aWYgKGZpbGUgPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xuXHRcdFx0c291bmRGaWxlTW9kaWZ5LiRzb3VuZEZpbGVOYW1lLnZhbChmaWxlLm5hbWUucmVwbGFjZSgvXFwuW14vLl0rJC8sICcnKSk7XG5cdFx0XHRzb3VuZEZpbGVNb2RpZnkuYmxvYiA9IHdpbmRvdy5VUkwgfHwgd2luZG93LndlYmtpdFVSTDtcblx0XHRcdGNvbnN0IGZpbGVVUkwgPSBzb3VuZEZpbGVNb2RpZnkuYmxvYi5jcmVhdGVPYmplY3RVUkwoZmlsZSk7XG5cdFx0XHRzbmRQbGF5ZXIuVXBkYXRlU291cmNlKGZpbGVVUkwpO1xuXHRcdFx0UGJ4QXBpLkZpbGVzVXBsb2FkRmlsZShmaWxlLCBzb3VuZEZpbGVNb2RpZnkuY2JVcGxvYWRSZXN1bWFibGUpO1xuXG5cdFx0fSk7XG5cblx0fSxcblxuXHQvKipcblx0ICogQ2FsbGJhY2sgZmlsZSB1cGxvYWQgd2l0aCBjaHVua3MgYW5kIG1lcmdlXG5cdCAqIEBwYXJhbSBhY3Rpb25cblx0ICogQHBhcmFtIHBhcmFtc1xuXHQgKi9cblx0Y2JVcGxvYWRSZXN1bWFibGUoYWN0aW9uLCBwYXJhbXMpe1xuXHRcdHN3aXRjaCAoYWN0aW9uKSB7XG5cdFx0XHRjYXNlICdmaWxlU3VjY2Vzcyc6XG5cdFx0XHRcdGNvbnN0IHJlc3BvbnNlID0gUGJ4QXBpLnRyeVBhcnNlSlNPTihwYXJhbXMucmVzcG9uc2UpO1xuXHRcdFx0XHRpZiAocmVzcG9uc2UgIT09ZmFsc2UgJiYgcmVzcG9uc2UuZGF0YS5maWxlbmFtZSE9PXVuZGVmaW5lZCl7XG5cdFx0XHRcdFx0c291bmRGaWxlTW9kaWZ5LiRzb3VuZEZpbGVOYW1lLnZhbChwYXJhbXMuZmlsZS5maWxlTmFtZSk7XG5cdFx0XHRcdFx0c291bmRGaWxlTW9kaWZ5LmNoZWNrU3RhdHVzRmlsZU1lcmdpbmcocGFyYW1zLnJlc3BvbnNlKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocGFyYW1zLCBnbG9iYWxUcmFuc2xhdGUuc2ZfVXBsb2FkRXJyb3IpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICd1cGxvYWRTdGFydCc6XG5cdFx0XHRcdHNvdW5kRmlsZU1vZGlmeS4kZm9ybU9iai5hZGRDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJ2Vycm9yJzpcblx0XHRcdFx0c291bmRGaWxlTW9kaWZ5LiRzdWJtaXRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0c291bmRGaWxlTW9kaWZ5LiRmb3JtT2JqLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRcdFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhwYXJhbXMsIGdsb2JhbFRyYW5zbGF0ZS5zZl9VcGxvYWRFcnJvcik7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHR9XG5cdH0sXG5cdC8qKlxuXHQgKiBXYWl0IGZvciBmaWxlIHJlYWR5IHRvIHVzZVxuXHQgKlxuXHQgKiBAcGFyYW0gcmVzcG9uc2Ug0L7RgtCy0LXRgiDRhNGD0L3QutGG0LjQuCAvcGJ4Y29yZS9hcGkvdXBsb2FkL3N0YXR1c1xuXHQgKi9cblx0Y2hlY2tTdGF0dXNGaWxlTWVyZ2luZyhyZXNwb25zZSkge1xuXHRcdGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IFBieEFwaS50cnlQYXJzZUpTT04ocmVzcG9uc2UpID09PSBmYWxzZSkge1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGAke2dsb2JhbFRyYW5zbGF0ZS5zZl9VcGxvYWRFcnJvcn1gKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Y29uc3QganNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2UpO1xuXHRcdGlmIChqc29uID09PSB1bmRlZmluZWQgfHwganNvbi5kYXRhID09PSB1bmRlZmluZWQpIHtcblx0XHRcdFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhgJHtnbG9iYWxUcmFuc2xhdGUuc2ZfVXBsb2FkRXJyb3J9YCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGNvbnN0IGZpbGVJRCA9IGpzb24uZGF0YS51cGxvYWRfaWQ7XG5cdFx0Y29uc3QgZmlsZVBhdGggPSBqc29uLmRhdGEuZmlsZW5hbWU7XG5cdFx0bWVyZ2luZ0NoZWNrV29ya2VyLmluaXRpYWxpemUoZmlsZUlELCBmaWxlUGF0aCk7XG5cdH0sXG5cdC8qKlxuXHQgKiBBZnRlciBmaWxlIGNvbnZlcnRlZCB0byBNUDMgZm9ybWF0XG5cdCAqIEBwYXJhbSBmaWxlbmFtZVxuXHQgKi9cblx0Y2JBZnRlckNvbnZlcnRGaWxlKGZpbGVuYW1lKSB7XG5cdFx0aWYgKGZpbGVuYW1lID09PSBmYWxzZSl7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoYCR7Z2xvYmFsVHJhbnNsYXRlLnNmX1VwbG9hZEVycm9yfWApO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRzb3VuZEZpbGVNb2RpZnkudHJhc2hCaW4ucHVzaChzb3VuZEZpbGVNb2RpZnkuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlJywgJ3BhdGgnKSk7XG5cdFx0XHRzb3VuZEZpbGVNb2RpZnkuJGZvcm1PYmouZm9ybSgnc2V0IHZhbHVlJywgJ3BhdGgnLCBmaWxlbmFtZSk7XG5cdFx0XHRzb3VuZEZpbGVNb2RpZnkuJHNvdW5kRmlsZU5hbWUudHJpZ2dlcignY2hhbmdlJyk7XG5cdFx0XHRzbmRQbGF5ZXIuVXBkYXRlU291cmNlKGAvcGJ4Y29yZS9hcGkvY2RyL3BsYXliYWNrP3ZpZXc9JHtmaWxlbmFtZX1gKTtcblx0XHRcdHNvdW5kRmlsZU1vZGlmeS4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRzb3VuZEZpbGVNb2RpZnkuJGZvcm1PYmoucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblxuXHRcdH1cblx0fSxcblx0Y2JCZWZvcmVTZW5kRm9ybShzZXR0aW5ncykge1xuXHRcdGNvbnN0IHJlc3VsdCA9IHNldHRpbmdzO1xuXHRcdHJlc3VsdC5kYXRhID0gc291bmRGaWxlTW9kaWZ5LiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9LFxuXHRjYkFmdGVyU2VuZEZvcm0oKSB7XG5cdFx0c291bmRGaWxlTW9kaWZ5LnRyYXNoQmluLmZvckVhY2goKGZpbGVwYXRoKSA9PiB7XG5cdFx0XHRpZiAoZmlsZXBhdGgpIFBieEFwaS5GaWxlc1JlbW92ZUF1ZGlvRmlsZShmaWxlcGF0aCk7XG5cdFx0fSk7XG5cdH0sXG5cdGluaXRpYWxpemVGb3JtKCkge1xuXHRcdGNvbnN0IGNhdGVnb3J5ID0gc291bmRGaWxlTW9kaWZ5LiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZScsICdjYXRlZ29yeScpO1xuXHRcdEZvcm0uJGZvcm1PYmogPSBzb3VuZEZpbGVNb2RpZnkuJGZvcm1PYmo7XG5cdFx0Rm9ybS51cmwgPSBgJHtnbG9iYWxSb290VXJsfXNvdW5kLWZpbGVzL3NhdmVgO1xuXHRcdEZvcm0udmFsaWRhdGVSdWxlcyA9IHNvdW5kRmlsZU1vZGlmeS52YWxpZGF0ZVJ1bGVzO1xuXHRcdEZvcm0uY2JCZWZvcmVTZW5kRm9ybSA9IHNvdW5kRmlsZU1vZGlmeS5jYkJlZm9yZVNlbmRGb3JtO1xuXHRcdEZvcm0uY2JBZnRlclNlbmRGb3JtID0gc291bmRGaWxlTW9kaWZ5LmNiQWZ0ZXJTZW5kRm9ybTtcblx0XHRGb3JtLmFmdGVyU3VibWl0TW9kaWZ5VXJsID0gYCR7Z2xvYmFsUm9vdFVybH1zb3VuZC1maWxlcy9tb2RpZnkvJHtjYXRlZ29yeX1gO1xuXHRcdEZvcm0uYWZ0ZXJTdWJtaXRJbmRleFVybCA9IGAke2dsb2JhbFJvb3RVcmx9c291bmQtZmlsZXMvaW5kZXgvIy8ke2NhdGVnb3J5fWA7XG5cdFx0Rm9ybS5pbml0aWFsaXplKCk7XG5cdH0sXG59O1xuXG5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcblx0c291bmRGaWxlTW9kaWZ5LmluaXRpYWxpemUoKTtcbn0pO1xuIl19