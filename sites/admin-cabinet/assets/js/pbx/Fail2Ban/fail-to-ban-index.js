"use strict";

/*
 * Copyright (C) MIKO LLC - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Nikolay Beketov, 12 2019
 *
 */

/* global globalTranslate, PbxApi, Form, globalRootUrl */
var fail2BanIndex = {
  $formObj: $('#fail2ban-settings-form'),
  $bannedIpList: $('#banned-ip-list'),
  $unbanButons: $('.unban-button'),
  $enableCheckBox: $('#fail2ban-switch'),
  validateRules: {
    maxretry: {
      identifier: 'maxretry',
      rules: [{
        type: 'integer[3..99]',
        prompt: globalTranslate.f2b_ValidateMaxRetryRange
      }]
    },
    findtime: {
      identifier: 'findtime',
      rules: [{
        type: 'integer[300..86400]',
        prompt: globalTranslate.f2b_ValidateFindTimeRange
      }]
    },
    bantime: {
      identifier: 'bantime',
      rules: [{
        type: 'integer[300..86400]',
        prompt: globalTranslate.f2b_ValidateBanTimeRange
      }]
    }
  },
  initialize: function () {
    function initialize() {
      PbxApi.SystemGetBannedIp(fail2BanIndex.cbGetBannedIpList);
      fail2BanIndex.$bannedIpList.on('click', fail2BanIndex.$unbanButons, function (e) {
        var unbannedIp = $(e.target).attr('data-value');
        PbxApi.SystemUnBanIp(unbannedIp, fail2BanIndex.cbAfterUnBanIp);
      });
      fail2BanIndex.$enableCheckBox.checkbox({
        onChange: function () {
          function onChange() {
            fail2BanIndex.changeFieldsLook();
          }

          return onChange;
        }()
      });
      fail2BanIndex.changeFieldsLook();
      fail2BanIndex.initializeForm();
    }

    return initialize;
  }(),
  changeFieldsLook: function () {
    function changeFieldsLook() {
      var checked = fail2BanIndex.$enableCheckBox.checkbox('is checked');
      fail2BanIndex.$formObj.find('.disability').each(function (index, obj) {
        if (checked) {
          $(obj).removeClass('disabled');
        } else {
          $(obj).addClass('disabled');
        }
      });
    }

    return changeFieldsLook;
  }(),
  cbGetBannedIpList: function () {
    function cbGetBannedIpList(response) {
      if (response === false) {
        return;
      }

      var htmlTable = "<h2 class=\"ui header\">".concat(globalTranslate.f2b_TableBannedHeader, "</h2>");
      htmlTable += '<table class="ui very compact table">';
      htmlTable += '<thead>';
      htmlTable += "<th>".concat(globalTranslate.f2b_Reason, "</th>");
      htmlTable += "<th>".concat(globalTranslate.f2b_IpAddres, "</th>");
      htmlTable += "<th>".concat(globalTranslate.f2b_BanedTime, "</th>");
      htmlTable += '<th></th>';
      htmlTable += '</thead>';
      htmlTable += '<tbody>';
      response.sort(function (a, b) {
        var keyA = a.timeofban;
        var keyB = b.timeofban; // Compare the 2 dates

        if (keyA < keyB) return 1;
        if (keyA > keyB) return -1;
        return 0;
      });
      $.each(response, function (key, value) {
        var blockDate = new Date(value.timeofban * 1000);
        var reason = "f2b_Jail_".concat(value.jail);

        if (reason in globalTranslate) {
          reason = globalTranslate[reason];
        }

        htmlTable += '<tr>';
        htmlTable += "<td>".concat(reason, "</td>");
        htmlTable += "<td>".concat(value.ip, "</td>");
        htmlTable += "<td>".concat(blockDate.toLocaleString(), "</td>");
        htmlTable += "<td class=\"right aligned collapsing\"><button class=\"ui icon basic mini button unban-button\" data-value=\"".concat(value.ip, "\"><i class=\"icon trash red\"></i>").concat(globalTranslate.f2b_Unban, "</button></td>");
        htmlTable += '</tr>';
      });

      if (response.length === 0) {
        htmlTable += "<tr><td colspan=\"4\" class=\"center aligned\">".concat(globalTranslate.f2b_TableBannedEmpty, "</td></tr>");
      }

      htmlTable += '<tbody>';
      htmlTable += '</table>';
      fail2BanIndex.$bannedIpList.html(htmlTable);
    }

    return cbGetBannedIpList;
  }(),
  cbAfterUnBanIp: function () {
    function cbAfterUnBanIp() {
      PbxApi.SystemGetBannedIp(fail2BanIndex.cbGetBannedIpList);
    }

    return cbAfterUnBanIp;
  }(),
  cbBeforeSendForm: function () {
    function cbBeforeSendForm(settings) {
      var result = settings;
      result.data = fail2BanIndex.$formObj.form('get values');
      return result;
    }

    return cbBeforeSendForm;
  }(),
  cbAfterSendForm: function () {
    function cbAfterSendForm() {}

    return cbAfterSendForm;
  }(),
  initializeForm: function () {
    function initializeForm() {
      Form.$formObj = fail2BanIndex.$formObj;
      Form.url = "".concat(globalRootUrl, "fail2-ban/save");
      Form.validateRules = fail2BanIndex.validateRules;
      Form.cbBeforeSendForm = fail2BanIndex.cbBeforeSendForm;
      Form.cbAfterSendForm = fail2BanIndex.cbAfterSendForm;
      Form.initialize();
    }

    return initializeForm;
  }()
};
$(document).ready(function () {
  fail2BanIndex.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9GYWlsMkJhbi9mYWlsLXRvLWJhbi1pbmRleC5qcyJdLCJuYW1lcyI6WyJmYWlsMkJhbkluZGV4IiwiJGZvcm1PYmoiLCIkIiwiJGJhbm5lZElwTGlzdCIsIiR1bmJhbkJ1dG9ucyIsIiRlbmFibGVDaGVja0JveCIsInZhbGlkYXRlUnVsZXMiLCJtYXhyZXRyeSIsImlkZW50aWZpZXIiLCJydWxlcyIsInR5cGUiLCJwcm9tcHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJmMmJfVmFsaWRhdGVNYXhSZXRyeVJhbmdlIiwiZmluZHRpbWUiLCJmMmJfVmFsaWRhdGVGaW5kVGltZVJhbmdlIiwiYmFudGltZSIsImYyYl9WYWxpZGF0ZUJhblRpbWVSYW5nZSIsImluaXRpYWxpemUiLCJQYnhBcGkiLCJTeXN0ZW1HZXRCYW5uZWRJcCIsImNiR2V0QmFubmVkSXBMaXN0Iiwib24iLCJlIiwidW5iYW5uZWRJcCIsInRhcmdldCIsImF0dHIiLCJTeXN0ZW1VbkJhbklwIiwiY2JBZnRlclVuQmFuSXAiLCJjaGVja2JveCIsIm9uQ2hhbmdlIiwiY2hhbmdlRmllbGRzTG9vayIsImluaXRpYWxpemVGb3JtIiwiY2hlY2tlZCIsImZpbmQiLCJlYWNoIiwiaW5kZXgiLCJvYmoiLCJyZW1vdmVDbGFzcyIsImFkZENsYXNzIiwicmVzcG9uc2UiLCJodG1sVGFibGUiLCJmMmJfVGFibGVCYW5uZWRIZWFkZXIiLCJmMmJfUmVhc29uIiwiZjJiX0lwQWRkcmVzIiwiZjJiX0JhbmVkVGltZSIsInNvcnQiLCJhIiwiYiIsImtleUEiLCJ0aW1lb2ZiYW4iLCJrZXlCIiwia2V5IiwidmFsdWUiLCJibG9ja0RhdGUiLCJEYXRlIiwicmVhc29uIiwiamFpbCIsImlwIiwidG9Mb2NhbGVTdHJpbmciLCJmMmJfVW5iYW4iLCJsZW5ndGgiLCJmMmJfVGFibGVCYW5uZWRFbXB0eSIsImh0bWwiLCJjYkJlZm9yZVNlbmRGb3JtIiwic2V0dGluZ3MiLCJyZXN1bHQiLCJkYXRhIiwiZm9ybSIsImNiQWZ0ZXJTZW5kRm9ybSIsIkZvcm0iLCJ1cmwiLCJnbG9iYWxSb290VXJsIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7Ozs7QUFRQTtBQUVBLElBQU1BLGFBQWEsR0FBRztBQUNyQkMsRUFBQUEsUUFBUSxFQUFFQyxDQUFDLENBQUMseUJBQUQsQ0FEVTtBQUVyQkMsRUFBQUEsYUFBYSxFQUFFRCxDQUFDLENBQUMsaUJBQUQsQ0FGSztBQUdyQkUsRUFBQUEsWUFBWSxFQUFFRixDQUFDLENBQUMsZUFBRCxDQUhNO0FBSXJCRyxFQUFBQSxlQUFlLEVBQUVILENBQUMsQ0FBQyxrQkFBRCxDQUpHO0FBS3JCSSxFQUFBQSxhQUFhLEVBQUU7QUFDZEMsSUFBQUEsUUFBUSxFQUFFO0FBQ1RDLE1BQUFBLFVBQVUsRUFBRSxVQURIO0FBRVRDLE1BQUFBLEtBQUssRUFBRSxDQUNOO0FBQ0NDLFFBQUFBLElBQUksRUFBRSxnQkFEUDtBQUVDQyxRQUFBQSxNQUFNLEVBQUVDLGVBQWUsQ0FBQ0M7QUFGekIsT0FETTtBQUZFLEtBREk7QUFVZEMsSUFBQUEsUUFBUSxFQUFFO0FBQ1ROLE1BQUFBLFVBQVUsRUFBRSxVQURIO0FBRVRDLE1BQUFBLEtBQUssRUFBRSxDQUNOO0FBQ0NDLFFBQUFBLElBQUksRUFBRSxxQkFEUDtBQUVDQyxRQUFBQSxNQUFNLEVBQUVDLGVBQWUsQ0FBQ0c7QUFGekIsT0FETTtBQUZFLEtBVkk7QUFtQmRDLElBQUFBLE9BQU8sRUFBRTtBQUNSUixNQUFBQSxVQUFVLEVBQUUsU0FESjtBQUVSQyxNQUFBQSxLQUFLLEVBQUUsQ0FDTjtBQUNDQyxRQUFBQSxJQUFJLEVBQUUscUJBRFA7QUFFQ0MsUUFBQUEsTUFBTSxFQUFFQyxlQUFlLENBQUNLO0FBRnpCLE9BRE07QUFGQztBQW5CSyxHQUxNO0FBbUNyQkMsRUFBQUEsVUFuQ3FCO0FBQUEsMEJBbUNSO0FBQ1pDLE1BQUFBLE1BQU0sQ0FBQ0MsaUJBQVAsQ0FBeUJwQixhQUFhLENBQUNxQixpQkFBdkM7QUFD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b0I7QUFBQTtBQWlIckJyQyxFQUFBQSxjQWpIcUI7QUFBQSw4QkFpSEo7QUFDaEJzQyxNQUFBQSxJQUFJLENBQUNyRSxRQUFMLEdBQWdCRCxhQUFhLENBQUNDLFFBQTlCO0FBQ0FxRSxNQUFBQSxJQUFJLENBQUNDLEdBQUwsYUFBY0MsYUFBZDtBQUNBRixNQUFBQSxJQUFJLENBQUNoRSxhQUFMLEdBQXFCTixhQUFhLENBQUNNLGFBQW5DO0FBQ0FnRSxNQUFBQSxJQUFJLENBQUNOLGdCQUFMLEdBQXdCaEUsYUFBYSxDQUFDZ0UsZ0JBQXRDO0FBQ0FNLE1BQUFBLElBQUksQ0FBQ0QsZUFBTCxHQUF1QnJFLGFBQWEsQ0FBQ3FFLGVBQXJDO0FBQ0FDLE1BQUFBLElBQUksQ0FBQ3BELFVBQUw7QUFDQTs7QUF4SG9CO0FBQUE7QUFBQSxDQUF0QjtBQTBIQWhCLENBQUMsQ0FBQ3VFLFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDdkIxRSxFQUFBQSxhQUFhLENBQUNrQixVQUFkO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKEMpIE1JS08gTExDIC0gQWxsIFJpZ2h0cyBSZXNlcnZlZFxuICogVW5hdXRob3JpemVkIGNvcHlpbmcgb2YgdGhpcyBmaWxlLCB2aWEgYW55IG1lZGl1bSBpcyBzdHJpY3RseSBwcm9oaWJpdGVkXG4gKiBQcm9wcmlldGFyeSBhbmQgY29uZmlkZW50aWFsXG4gKiBXcml0dGVuIGJ5IE5pa29sYXkgQmVrZXRvdiwgMTIgMjAxOVxuICpcbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsVHJhbnNsYXRlLCBQYnhBcGksIEZvcm0sIGdsb2JhbFJvb3RVcmwgKi9cblxuY29uc3QgZmFpbDJCYW5JbmRleCA9IHtcblx0JGZvcm1PYmo6ICQoJyNmYWlsMmJhbi1zZXR0aW5ncy1mb3JtJyksXG5cdCRiYW5uZWRJcExpc3Q6ICQoJyNiYW5uZWQtaXAtbGlzdCcpLFxuXHQkdW5iYW5CdXRvbnM6ICQoJy51bmJhbi1idXR0b24nKSxcblx0JGVuYWJsZUNoZWNrQm94OiAkKCcjZmFpbDJiYW4tc3dpdGNoJyksXG5cdHZhbGlkYXRlUnVsZXM6IHtcblx0XHRtYXhyZXRyeToge1xuXHRcdFx0aWRlbnRpZmllcjogJ21heHJldHJ5Jyxcblx0XHRcdHJ1bGVzOiBbXG5cdFx0XHRcdHtcblx0XHRcdFx0XHR0eXBlOiAnaW50ZWdlclszLi45OV0nLFxuXHRcdFx0XHRcdHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmYyYl9WYWxpZGF0ZU1heFJldHJ5UmFuZ2UsXG5cdFx0XHRcdH0sXG5cdFx0XHRdLFxuXHRcdH0sXG5cdFx0ZmluZHRpbWU6IHtcblx0XHRcdGlkZW50aWZpZXI6ICdmaW5kdGltZScsXG5cdFx0XHRydWxlczogW1xuXHRcdFx0XHR7XG5cdFx0XHRcdFx0dHlwZTogJ2ludGVnZXJbMzAwLi44NjQwMF0nLFxuXHRcdFx0XHRcdHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmYyYl9WYWxpZGF0ZUZpbmRUaW1lUmFuZ2UsXG5cdFx0XHRcdH0sXG5cdFx0XHRdLFxuXHRcdH0sXG5cdFx0YmFudGltZToge1xuXHRcdFx0aWRlbnRpZmllcjogJ2JhbnRpbWUnLFxuXHRcdFx0cnVsZXM6IFtcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHR5cGU6ICdpbnRlZ2VyWzMwMC4uODY0MDBdJyxcblx0XHRcdFx0XHRwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5mMmJfVmFsaWRhdGVCYW5UaW1lUmFuZ2UsXG5cdFx0XHRcdH0sXG5cdFx0XHRdLFxuXHRcdH0sXG5cdH0sXG5cblx0aW5pdGlhbGl6ZSgpIHtcblx0XHRQYnhBcGkuU3lzdGVtR2V0QmFubmVkSXAoZmFpbDJCYW5JbmRleC5jYkdldEJhbm5lZElwTGlzdCk7XG5cdFx0ZmFpbDJCYW5JbmRleC4kYmFubmVkSXBMaXN0Lm9uKCdjbGljaycsIGZhaWwyQmFuSW5kZXguJHVuYmFuQnV0b25zLCAoZSkgPT4ge1xuXHRcdFx0Y29uc3QgdW5iYW5uZWRJcCA9ICQoZS50YXJnZXQpLmF0dHIoJ2RhdGEtdmFsdWUnKTtcblx0XHRcdFBieEFwaS5TeXN0ZW1VbkJhbklwKHVuYmFubmVkSXAsIGZhaWwyQmFuSW5kZXguY2JBZnRlclVuQmFuSXApO1xuXHRcdH0pO1xuXG5cdFx0ZmFpbDJCYW5JbmRleC4kZW5hYmxlQ2hlY2tCb3guY2hlY2tib3goe1xuXHRcdFx0b25DaGFuZ2UoKSB7XG5cdFx0XHRcdGZhaWwyQmFuSW5kZXguY2hhbmdlRmllbGRzTG9vaygpO1xuXHRcdFx0fSxcblx0XHR9KTtcblx0XHRmYWlsMkJhbkluZGV4LmNoYW5nZUZpZWxkc0xvb2soKTtcblx0XHRmYWlsMkJhbkluZGV4LmluaXRpYWxpemVGb3JtKCk7XG5cdH0sXG5cdGNoYW5nZUZpZWxkc0xvb2soKSB7XG5cdFx0Y29uc3QgY2hlY2tlZCA9IGZhaWwyQmFuSW5kZXguJGVuYWJsZUNoZWNrQm94LmNoZWNrYm94KCdpcyBjaGVja2VkJyk7XG5cdFx0ZmFpbDJCYW5JbmRleC4kZm9ybU9iai5maW5kKCcuZGlzYWJpbGl0eScpLmVhY2goKGluZGV4LCBvYmopID0+IHtcblx0XHRcdGlmIChjaGVja2VkKSB7XG5cdFx0XHRcdCQob2JqKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdCQob2JqKS5hZGRDbGFzcygnZGlzYWJsZWQnKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSxcblx0Y2JHZXRCYW5uZWRJcExpc3QocmVzcG9uc2UpIHtcblx0XHRpZiAocmVzcG9uc2U9PT1mYWxzZSl7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGxldCBodG1sVGFibGUgPSBgPGgyIGNsYXNzPVwidWkgaGVhZGVyXCI+JHtnbG9iYWxUcmFuc2xhdGUuZjJiX1RhYmxlQmFubmVkSGVhZGVyfTwvaDI+YDtcblx0XHRodG1sVGFibGUgKz0gJzx0YWJsZSBjbGFzcz1cInVpIHZlcnkgY29tcGFjdCB0YWJsZVwiPic7XG5cdFx0aHRtbFRhYmxlICs9ICc8dGhlYWQ+Jztcblx0XHRodG1sVGFibGUgKz0gYDx0aD4ke2dsb2JhbFRyYW5zbGF0ZS5mMmJfUmVhc29ufTwvdGg+YDtcblx0XHRodG1sVGFibGUgKz0gYDx0aD4ke2dsb2JhbFRyYW5zbGF0ZS5mMmJfSXBBZGRyZXN9PC90aD5gO1xuXHRcdGh0bWxUYWJsZSArPSBgPHRoPiR7Z2xvYmFsVHJhbnNsYXRlLmYyYl9CYW5lZFRpbWV9PC90aD5gO1xuXHRcdGh0bWxUYWJsZSArPSAnPHRoPjwvdGg+Jztcblx0XHRodG1sVGFibGUgKz0gJzwvdGhlYWQ+Jztcblx0XHRodG1sVGFibGUgKz0gJzx0Ym9keT4nO1xuXHRcdHJlc3BvbnNlLnNvcnQoKGEsIGIpID0+IHtcblx0XHRcdGNvbnN0IGtleUEgPSBhLnRpbWVvZmJhbjtcblx0XHRcdGNvbnN0IGtleUIgPSBiLnRpbWVvZmJhbjtcblx0XHRcdC8vIENvbXBhcmUgdGhlIDIgZGF0ZXNcblx0XHRcdGlmIChrZXlBIDwga2V5QikgcmV0dXJuIDE7XG5cdFx0XHRpZiAoa2V5QSA+IGtleUIpIHJldHVybiAtMTtcblx0XHRcdHJldHVybiAwO1xuXHRcdH0pO1xuXHRcdCQuZWFjaChyZXNwb25zZSwgKGtleSwgdmFsdWUpID0+IHtcblx0XHRcdGNvbnN0IGJsb2NrRGF0ZSA9IG5ldyBEYXRlKHZhbHVlLnRpbWVvZmJhbiAqIDEwMDApO1xuXHRcdFx0bGV0IHJlYXNvbiA9IGBmMmJfSmFpbF8ke3ZhbHVlLmphaWx9YDtcblx0XHRcdGlmIChyZWFzb24gaW4gZ2xvYmFsVHJhbnNsYXRlKSB7XG5cdFx0XHRcdHJlYXNvbiA9IGdsb2JhbFRyYW5zbGF0ZVtyZWFzb25dO1xuXHRcdFx0fVxuXG5cdFx0XHRodG1sVGFibGUgKz0gJzx0cj4nO1xuXHRcdFx0aHRtbFRhYmxlICs9IGA8dGQ+JHtyZWFzb259PC90ZD5gO1xuXHRcdFx0aHRtbFRhYmxlICs9IGA8dGQ+JHt2YWx1ZS5pcH08L3RkPmA7XG5cdFx0XHRodG1sVGFibGUgKz0gYDx0ZD4ke2Jsb2NrRGF0ZS50b0xvY2FsZVN0cmluZygpfTwvdGQ+YDtcblx0XHRcdGh0bWxUYWJsZSArPSBgPHRkIGNsYXNzPVwicmlnaHQgYWxpZ25lZCBjb2xsYXBzaW5nXCI+PGJ1dHRvbiBjbGFzcz1cInVpIGljb24gYmFzaWMgbWluaSBidXR0b24gdW5iYW4tYnV0dG9uXCIgZGF0YS12YWx1ZT1cIiR7dmFsdWUuaXB9XCI+PGkgY2xhc3M9XCJpY29uIHRyYXNoIHJlZFwiPjwvaT4ke2dsb2JhbFRyYW5zbGF0ZS5mMmJfVW5iYW59PC9idXR0b24+PC90ZD5gO1xuXHRcdFx0aHRtbFRhYmxlICs9ICc8L3RyPic7XG5cdFx0fSk7XG5cdFx0aWYgKHJlc3BvbnNlLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0aHRtbFRhYmxlICs9IGA8dHI+PHRkIGNvbHNwYW49XCI0XCIgY2xhc3M9XCJjZW50ZXIgYWxpZ25lZFwiPiR7Z2xvYmFsVHJhbnNsYXRlLmYyYl9UYWJsZUJhbm5lZEVtcHR5fTwvdGQ+PC90cj5gO1xuXHRcdH1cblx0XHRodG1sVGFibGUgKz0gJzx0Ym9keT4nO1xuXHRcdGh0bWxUYWJsZSArPSAnPC90YWJsZT4nO1xuXHRcdGZhaWwyQmFuSW5kZXguJGJhbm5lZElwTGlzdC5odG1sKGh0bWxUYWJsZSk7XG5cdH0sXG5cdGNiQWZ0ZXJVbkJhbklwKCkge1xuXHRcdFBieEFwaS5TeXN0ZW1HZXRCYW5uZWRJcChmYWlsMkJhbkluZGV4LmNiR2V0QmFubmVkSXBMaXN0KTtcblx0fSxcblx0Y2JCZWZvcmVTZW5kRm9ybShzZXR0aW5ncykge1xuXHRcdGNvbnN0IHJlc3VsdCA9IHNldHRpbmdzO1xuXHRcdHJlc3VsdC5kYXRhID0gZmFpbDJCYW5JbmRleC4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fSxcblx0Y2JBZnRlclNlbmRGb3JtKCkge1xuXG5cdH0sXG5cdGluaXRpYWxpemVGb3JtKCkge1xuXHRcdEZvcm0uJGZvcm1PYmogPSBmYWlsMkJhbkluZGV4LiRmb3JtT2JqO1xuXHRcdEZvcm0udXJsID0gYCR7Z2xvYmFsUm9vdFVybH1mYWlsMi1iYW4vc2F2ZWA7XG5cdFx0Rm9ybS52YWxpZGF0ZVJ1bGVzID0gZmFpbDJCYW5JbmRleC52YWxpZGF0ZVJ1bGVzO1xuXHRcdEZvcm0uY2JCZWZvcmVTZW5kRm9ybSA9IGZhaWwyQmFuSW5kZXguY2JCZWZvcmVTZW5kRm9ybTtcblx0XHRGb3JtLmNiQWZ0ZXJTZW5kRm9ybSA9IGZhaWwyQmFuSW5kZXguY2JBZnRlclNlbmRGb3JtO1xuXHRcdEZvcm0uaW5pdGlhbGl6ZSgpO1xuXHR9LFxufTtcbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcblx0ZmFpbDJCYW5JbmRleC5pbml0aWFsaXplKCk7XG59KTtcblxuIl19