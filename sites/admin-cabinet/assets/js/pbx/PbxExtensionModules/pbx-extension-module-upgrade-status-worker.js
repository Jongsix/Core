"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage, extensionModules */

/**
 * Мониторинг статуса обновления или установки модуля
 *
 */
var upgradeStatusLoopWorker = {
  timeOut: 1000,
  timeOutHandle: '',
  moduleUniqid: '',
  iterations: 0,
  oldPercent: '0',
  needEnableAfterInstall: false,
  initialize: function () {
    function initialize(uniqid, needEnable) {
      upgradeStatusLoopWorker.moduleUniqid = uniqid;
      upgradeStatusLoopWorker.iterations = 0;
      upgradeStatusLoopWorker.needEnableAfterInstall = needEnable;
      upgradeStatusLoopWorker.restartWorker();
    }

    return initialize;
  }(),
  restartWorker: function () {
    function restartWorker() {
      window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
      upgradeStatusLoopWorker.worker();
    }

    return restartWorker;
  }(),
  worker: function () {
    function worker() {
      window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
      PbxApi.FilesModuleDownloadStatus(upgradeStatusLoopWorker.moduleUniqid, upgradeStatusLoopWorker.cbRefreshModuleStatus, upgradeStatusLoopWorker.restartWorker);
    }

    return worker;
  }(),
  cbRefreshModuleStatus: function () {
    function cbRefreshModuleStatus(response) {
      upgradeStatusLoopWorker.iterations += 1;
      upgradeStatusLoopWorker.timeoutHandle = window.setTimeout(upgradeStatusLoopWorker.worker, upgradeStatusLoopWorker.timeOut); // Check download status

      if (response === false && upgradeStatusLoopWorker.iterations < 50) {
        window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
      } else if (upgradeStatusLoopWorker.iterations > 50 || response.d_status === 'DOWNLOAD_ERROR' || response.d_status === 'NOT_FOUND') {
        window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
        var errorMessage = response.d_error !== undefined ? response.d_error : '';
        errorMessage = errorMessage.replace(/\n/g, '<br>');
        UserMessage.showMultiString(errorMessage, globalTranslate.ext_UpdateModuleError);
        $("#".concat(upgradeStatusLoopWorker.moduleUniqid)).find('i').removeClass('loading');
        $('.new-module-row').find('i').addClass('download').removeClass('redo');
        $('a.button').removeClass('disabled');
      } else if (response.d_status === 'DOWNLOAD_IN_PROGRESS') {
        if (upgradeStatusLoopWorker.oldPercent !== response.d_status_progress) {
          upgradeStatusLoopWorker.iterations = 0;
        }

        $('i.loading.redo').closest('a').find('.percent').text("".concat(response.d_status_progress, "%"));
        upgradeStatusLoopWorker.oldPercent = response.d_status_progress;
      } else if (response.d_status === 'DOWNLOAD_COMPLETE') {
        $('i.loading.redo').closest('a').find('.percent').text('100%');
        PbxApi.SystemInstallModule(response.filePath, upgradeStatusLoopWorker.cbAfterModuleInstall);
        window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
      }
    }

    return cbRefreshModuleStatus;
  }(),
  cbAfterModuleInstall: function () {
    function cbAfterModuleInstall(response) {
      if (response.length === 0 || response === false) {
        UserMessage.showMultiString(response, globalTranslate.ext_InstallationError);
      } else {
        // Check installation status
        if (upgradeStatusLoopWorker.needEnableAfterInstall) {
          PbxApi.SystemEnableModule(upgradeStatusLoopWorker.moduleUniqid, function () {
            window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
          });
        } else {
          window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
        }
      }
    }

    return cbAfterModuleInstall;
  }()
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLXVwZ3JhZGUtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJ1cGdyYWRlU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwibW9kdWxlVW5pcWlkIiwiaXRlcmF0aW9ucyIsIm9sZFBlcmNlbnQiLCJuZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsIiwiaW5pdGlhbGl6ZSIsInVuaXFpZCIsIm5lZWRFbmFibGUiLCJyZXN0YXJ0V29ya2VyIiwid2luZG93IiwiY2xlYXJUaW1lb3V0IiwidGltZW91dEhhbmRsZSIsIndvcmtlciIsIlBieEFwaSIsIkZpbGVzTW9kdWxlRG93bmxvYWRTdGF0dXMiLCJjYlJlZnJlc2hNb2R1bGVTdGF0dXMiLCJyZXNwb25zZSIsInNldFRpbWVvdXQiLCJkX3N0YXR1cyIsImVycm9yTWVzc2FnZSIsImRfZXJyb3IiLCJ1bmRlZmluZWQiLCJyZXBsYWNlIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfVXBkYXRlTW9kdWxlRXJyb3IiLCIkIiwiZmluZCIsInJlbW92ZUNsYXNzIiwiYWRkQ2xhc3MiLCJkX3N0YXR1c19wcm9ncmVzcyIsImNsb3Nlc3QiLCJ0ZXh0IiwiU3lzdGVtSW5zdGFsbE1vZHVsZSIsImZpbGVQYXRoIiwiY2JBZnRlck1vZHVsZUluc3RhbGwiLCJsZW5ndGgiLCJleHRfSW5zdGFsbGF0aW9uRXJyb3IiLCJTeXN0ZW1FbmFibGVNb2R1bGUiLCJsb2NhdGlvbiIsImdsb2JhbFJvb3RVcmwiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWtCQTs7QUFFQTs7OztBQUlBLElBQU1BLHVCQUF1QixHQUFHO0FBQy9CQyxFQUFBQSxPQUFPLEVBQUUsSUFEc0I7QUFFL0JDLEVBQUFBLGFBQWEsRUFBRSxFQUZnQjtBQUcvQkMsRUFB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LENBQUMrQixRQUFQLGFBQXFCQyxhQUFyQjtBQUNBLFdBSkY7QUFNQSxTQVBELE1BT087QUFDTmhDLFVBQUFBLE1BQU0sQ0FBQytCLFFBQVAsYUFBcUJDLGFBQXJCO0FBQ0E7QUFDRDtBQUVEOztBQXpFOEI7QUFBQTtBQUFBLENBQWhDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCAoQykgMjAxNy0yMDIwIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGksIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UsIGV4dGVuc2lvbk1vZHVsZXMgKi9cblxuLyoqXG4gKiDQnNC+0L3QuNGC0L7RgNC40L3QsyDRgdGC0LDRgtGD0YHQsCDQvtCx0L3QvtCy0LvQtdC90LjRjyDQuNC70Lgg0YPRgdGC0LDQvdC+0LLQutC4INC80L7QtNGD0LvRj1xuICpcbiAqL1xuY29uc3QgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIgPSB7XG5cdHRpbWVPdXQ6IDEwMDAsXG5cdHRpbWVPdXRIYW5kbGU6ICcnLFxuXHRtb2R1bGVVbmlxaWQ6ICcnLFxuXHRpdGVyYXRpb25zOiAwLFxuXHRvbGRQZXJjZW50OiAnMCcsXG5cdG5lZWRFbmFibGVBZnRlckluc3RhbGw6IGZhbHNlLFxuXHRpbml0aWFsaXplKHVuaXFpZCwgbmVlZEVuYWJsZSkge1xuXHRcdHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLm1vZHVsZVVuaXFpZCA9IHVuaXFpZDtcblx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zID0gMDtcblx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5uZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsID0gbmVlZEVuYWJsZTtcblx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG5cdH0sXG5cdHJlc3RhcnRXb3JrZXIoKSB7XG5cdFx0d2luZG93LmNsZWFyVGltZW91dCh1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci53b3JrZXIoKTtcblx0fSxcblx0d29ya2VyKCkge1xuXHRcdHdpbmRvdy5jbGVhclRpbWVvdXQodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdFx0UGJ4QXBpLkZpbGVzTW9kdWxlRG93bmxvYWRTdGF0dXMoXG5cdFx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5tb2R1bGVVbmlxaWQsXG5cdFx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5jYlJlZnJlc2hNb2R1bGVTdGF0dXMsXG5cdFx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyLFxuXHRcdCk7XG5cdH0sXG5cdGNiUmVmcmVzaE1vZHVsZVN0YXR1cyhyZXNwb25zZSkge1xuXHRcdHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgKz0gMTtcblx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlID1cblx0XHRcdHdpbmRvdy5zZXRUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLndvcmtlciwgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIudGltZU91dCk7XG5cdFx0Ly8gQ2hlY2sgZG93bmxvYWQgc3RhdHVzXG5cdFx0aWYgKHJlc3BvbnNlID09PSBmYWxzZVxuXHRcdFx0JiYgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA8IDUwKSB7XG5cdFx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdH0gZWxzZSBpZiAodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA+IDUwXG5cdFx0XHR8fCByZXNwb25zZS5kX3N0YXR1cyA9PT0gJ0RPV05MT0FEX0VSUk9SJ1xuXHRcdFx0fHwgcmVzcG9uc2UuZF9zdGF0dXMgPT09ICdOT1RfRk9VTkQnXG5cdFx0KSB7XG5cdFx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdFx0bGV0IGVycm9yTWVzc2FnZSA9IChyZXNwb25zZS5kX2Vycm9yICE9PSB1bmRlZmluZWQpID8gcmVzcG9uc2UuZF9lcnJvciA6ICcnO1xuXHRcdFx0ZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlLnJlcGxhY2UoL1xcbi9nLCAnPGJyPicpO1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGVycm9yTWVzc2FnZSwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGRhdGVNb2R1bGVFcnJvcik7XG5cdFx0XHQkKGAjJHt1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5tb2R1bGVVbmlxaWR9YCkuZmluZCgnaScpLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHQkKCcubmV3LW1vZHVsZS1yb3cnKS5maW5kKCdpJykuYWRkQ2xhc3MoJ2Rvd25sb2FkJykucmVtb3ZlQ2xhc3MoJ3JlZG8nKTtcblx0XHRcdCQoJ2EuYnV0dG9uJykucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0fSBlbHNlIGlmIChyZXNwb25zZS5kX3N0YXR1cyA9PT0gJ0RPV05MT0FEX0lOX1BST0dSRVNTJykge1xuXHRcdFx0aWYgKHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLm9sZFBlcmNlbnQgIT09IHJlc3BvbnNlLmRfc3RhdHVzX3Byb2dyZXNzKSB7XG5cdFx0XHRcdHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPSAwO1xuXHRcdFx0fVxuXHRcdFx0JCgnaS5sb2FkaW5nLnJlZG8nKS5jbG9zZXN0KCdhJykuZmluZCgnLnBlcmNlbnQnKS50ZXh0KGAke3Jlc3BvbnNlLmRfc3RhdHVzX3Byb2dyZXNzfSVgKTtcblx0XHRcdHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLm9sZFBlcmNlbnQgPSByZXNwb25zZS5kX3N0YXR1c19wcm9ncmVzcztcblx0XHR9IGVsc2UgaWYgKHJlc3BvbnNlLmRfc3RhdHVzID09PSAnRE9XTkxPQURfQ09NUExFVEUnKSB7XG5cdFx0XHQkKCdpLmxvYWRpbmcucmVkbycpLmNsb3Nlc3QoJ2EnKS5maW5kKCcucGVyY2VudCcpLnRleHQoJzEwMCUnKTtcblx0XHRcdFBieEFwaS5TeXN0ZW1JbnN0YWxsTW9kdWxlKHJlc3BvbnNlLmZpbGVQYXRoLCB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyTW9kdWxlSW5zdGFsbCk7XG5cdFx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdH1cblx0fSxcblx0Y2JBZnRlck1vZHVsZUluc3RhbGwocmVzcG9uc2UpIHtcblx0XHRpZiAocmVzcG9uc2UubGVuZ3RoID09PSAwIHx8IHJlc3BvbnNlID09PSBmYWxzZSkge1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHQvLyBDaGVjayBpbnN0YWxsYXRpb24gc3RhdHVzXG5cdFx0XHRpZiAodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIubmVlZEVuYWJsZUFmdGVySW5zdGFsbCkge1xuXHRcdFx0XHRQYnhBcGkuU3lzdGVtRW5hYmxlTW9kdWxlKFxuXHRcdFx0XHRcdHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLm1vZHVsZVVuaXFpZCxcblx0XHRcdFx0XHQoKSA9PiB7XG5cdFx0XHRcdFx0XHR3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfXBieC1leHRlbnNpb24tbW9kdWxlcy9pbmRleC9gO1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfXBieC1leHRlbnNpb24tbW9kdWxlcy9pbmRleC9gO1xuXHRcdFx0fVxuXHRcdH1cblxuXHR9LFxufTtcbiJdfQ==