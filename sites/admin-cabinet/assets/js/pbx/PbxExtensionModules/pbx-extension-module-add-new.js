"use strict";

/*
 * Copyright (C) MIKO LLC - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Nikolay Beketov, 12 2019
 *
 */

/* global UserMessage, globalTranslate, PbxApi, upgradeStatusLoopWorker */
var addNewExtension = {
  $uploadButton: $('#add-new-button'),
  $progressBar: $('#upload-progress-bar'),
  $progressBarLabel: $('#upload-progress-bar').find('.label'),
  uploadInProgress: false,
  initialize: function () {
    function initialize() {
      addNewExtension.$progressBar.hide();
      PbxApi.SystemUploadFileAttachToBtn('add-new-button', ['zip'], addNewExtension.cbResumableUploadFile);
    }

    return initialize;
  }(),

  /**
   * Upload file by chunks
   * @param action
   * @param params
   */
  cbResumableUploadFile: function () {
    function cbResumableUploadFile(action, params) {
      switch (action) {
        case 'fileSuccess':
          addNewExtension.checkStatusFileMerging(params.response);
          break;

        case 'uploadStart':
          addNewExtension.uploadInProgress = true;
          addNewExtension.$uploadButton.addClass('loading');
          addNewExtension.$progressBar.show();
          addNewExtension.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
          break;

        case 'progress':
          addNewExtension.$progressBar.progress({
            percent: parseInt(params.percent, 10)
          });
          break;

        case 'error':
          addNewExtension.$progressBarLabel.text(globalTranslate.ext_UploadError);
          addNewExtension.$uploadButton.removeClass('loading');
          UserMessage.showError(globalTranslate.ext_UploadError);
          break;

        default:
      }
    }

    return cbResumableUploadFile;
  }(),

  /**
   * Wait for file ready to use
   *
   * @param response ответ функции /pbxcore/api/upload/status
   */
  checkStatusFileMerging: function () {
    function checkStatusFileMerging(response) {
      if (response === undefined || PbxApi.tryParseJSON(response) === false) {
        UserMessage.showError("".concat(globalTranslate.ext_UploadError));
        return;
      }

      var json = JSON.parse(response);

      if (json === undefined || json.data === undefined) {
        UserMessage.showError("".concat(globalTranslate.ext_UploadError));
        return;
      }

      var fileID = json.data.upload_id;
      var filePath = json.data.filename;
      mergingCheckWorker.initialize(fileID, filePath);
    }

    return checkStatusFileMerging;
  }()
};
var mergingCheckWorker = {
  timeOut: 3000,
  timeOutHandle: '',
  errorCounts: 0,
  $progressBarLabel: $('#upload-progress-bar').find('.label'),
  fileID: null,
  filePath: '',
  initialize: function () {
    function initialize(fileID, filePath) {
      // Запустим обновление статуса провайдера
      mergingCheckWorker.fileID = fileID;
      mergingCheckWorker.filePath = filePath;
      mergingCheckWorker.restartWorker(fileID);
    }

    return initialize;
  }(),
  restartWorker: function () {
    function restartWorker() {
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
      mergingCheckWorker.worker();
    }

    return restartWorker;
  }(),
  worker: function () {
    function worker() {
      PbxApi.SystemGetStatusUploadFile(mergingCheckWorker.fileID, mergingCheckWorker.cbAfterResponse);
      mergingCheckWorker.timeoutHandle = window.setTimeout(mergingCheckWorker.worker, mergingCheckWorker.timeOut);
    }

    return worker;
  }(),
  cbAfterResponse: function () {
    function cbAfterResponse(response) {
      if (mergingCheckWorker.errorCounts > 10) {
        mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_UploadError);
        UserMessage.showError(response, globalTranslate.ext_UploadError);
        addNewExtension.$uploadButton.removeClass('loading');
        window.clearTimeout(mergingCheckWorker.timeoutHandle);
      }

      if (response === undefined || Object.keys(response).length === 0) {
        mergingCheckWorker.errorCounts += 1;
        return;
      }

      if (response.d_status === 'UPLOAD_COMPLETE') {
        mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_InstallationInProgress);
        PbxApi.SystemInstallModule(mergingCheckWorker.filePath, mergingCheckWorker.cbAfterModuleInstall);
        window.clearTimeout(mergingCheckWorker.timeoutHandle);
      } else if (response.d_status !== undefined) {
        mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
        mergingCheckWorker.errorCounts = 0;
      } else {
        mergingCheckWorker.errorCounts += 1;
      }
    }

    return cbAfterResponse;
  }(),
  cbAfterModuleInstall: function () {
    function cbAfterModuleInstall(response) {
      if (response === true) {
        window.location.reload();
      } else {
        UserMessage.showMultiString(response, globalTranslate.ext_InstallationError);
        addNewExtension.$uploadButton.removeClass('loading');
      }
    }

    return cbAfterModuleInstall;
  }()
};
$(document).ready(function () {
  addNewExtension.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWFkZC1uZXcuanMiXSwibmFtZXMiOlsiYWRkTmV3RXh0ZW5zaW9uIiwiJHVwbG9hZEJ1dHRvbiIsIiQiLCIkcHJvZ3Jlc3NCYXIiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsImZpbmQiLCJ1cGxvYWRJblByb2dyZXNzIiwiaW5pdGlhbGl6ZSIsImhpZGUiLCJQYnhBcGkiLCJTeXN0ZW1VcGxvYWRGaWxlQXR0YWNoVG9CdG4iLCJjYlJlc3VtYWJsZVVwbG9hZEZpbGUiLCJhY3Rpb24iLCJwYXJhbXMiLCJjaGVja1N0YXR1c0ZpbGVNZXJnaW5nIiwicmVzcG9uc2UiLCJhZGRDbGFzcyIsInNob3ciLCJ0ZXh0IiwiZ2xvYmFsVHJhbnNsYXRlIiwiZXh0X1VwbG9hZEluUHJvZ3Jlc3MiLCJwcm9ncmVzcyIsInBlcmNlbnQiLCJwYXJzZUludCIsImV4dF9VcGxvYWRFcnJvciIsInJlbW92ZUNsYXNzIiwiVXNlck1lc3NhZ2UiLCJzaG93RXJyb3IiLCJ1bmRlZmluZWQiLCJ0cnlQYXJzZUpTT04iLCJqc29uIiwiSlNPTiIsInBhcnNlIiwiZGF0YSIsImZpbGVJRCIsInVwbG9hZF9pZCIsImZpbGVQYXRoIiwiZmlsZW5hbWUiLCJtZXJnaW5nQ2hlY2tXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImVycm9yQ291bnRzIiwicmVzdGFydFdvcmtlciIsIndpbmRvdyIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJTeXN0ZW1HZXRTdGF0dXNVcGxvYWRGaWxlIiwiY2JBZnRlclJlc3BvbnNlIiwic2V0VGltZW91dCIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJkX3N0YXR1cyIsImV4dF9JbnN0YWxsYXRpb25JblByb2dyZXNzIiwiU3lzdGVtSW5zdGFsbE1vZHVsZSIsImNiQWZ0ZXJNb2R1bGVJbnN0YWxsIiwibG9jYXRpb24iLCJyZWxv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O0FBQ0EsT0FITSxNQUdBO0FBQ05ILFFBQUFBLGtCQUFrQixDQUFDRyxXQUFuQixJQUFrQyxDQUFsQztBQUNBO0FBQ0Q7O0FBN0N5QjtBQUFBO0FBOEMxQmUsRUFBQUEsb0JBOUMwQjtBQUFBLGtDQThDTHpDLFFBOUNLLEVBOENJO0FBQzdCLFVBQUlBLFFBQVEsS0FBRyxJQUFmLEVBQW9CO0FBQ25CNEIsUUFBQUEsTUFBTSxDQUFDYyxRQUFQLENBQWdCQyxNQUFoQjtBQUNBLE9BRkQsTUFFTztBQUNOaEMsUUFBQUEsV0FBVyxDQUFDaUMsZUFBWixDQUE0QjVDLFFBQTVCLEVBQXNDSSxlQUFlLENBQUN5QyxxQkFBdEQ7QUFDQTVELFFBQUFBLGVBQWUsQ0FBQ0MsYUFBaEIsQ0FBOEJ3QixXQUE5QixDQUEwQyxTQUExQztBQUNBO0FBQ0Q7O0FBckR5QjtBQUFBO0FBQUEsQ0FBM0I7QUF3REF2QixDQUFDLENBQUMyRCxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3ZCOUQsRUFBQUEsZUFBZSxDQUFDTyxVQUFoQjtBQUNBLENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChDKSBNSUtPIExMQyAtIEFsbCBSaWdodHMgUmVzZXJ2ZWRcbiAqIFVuYXV0aG9yaXplZCBjb3B5aW5nIG9mIHRoaXMgZmlsZSwgdmlhIGFueSBtZWRpdW0gaXMgc3RyaWN0bHkgcHJvaGliaXRlZFxuICogUHJvcHJpZXRhcnkgYW5kIGNvbmZpZGVudGlhbFxuICogV3JpdHRlbiBieSBOaWtvbGF5IEJla2V0b3YsIDEyIDIwMTlcbiAqXG4gKi9cblxuLyogZ2xvYmFsIFVzZXJNZXNzYWdlLCBnbG9iYWxUcmFuc2xhdGUsIFBieEFwaSwgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIgKi8gXG5cbmNvbnN0IGFkZE5ld0V4dGVuc2lvbiA9IHtcblx0JHVwbG9hZEJ1dHRvbjogJCgnI2FkZC1uZXctYnV0dG9uJyksXG5cdCRwcm9ncmVzc0JhcjogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKSxcblx0JHByb2dyZXNzQmFyTGFiZWw6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyJykuZmluZCgnLmxhYmVsJyksXG5cdHVwbG9hZEluUHJvZ3Jlc3M6IGZhbHNlLFxuXHRpbml0aWFsaXplKCkge1xuXHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXIuaGlkZSgpO1xuXHRcdFBieEFwaS5TeXN0ZW1VcGxvYWRGaWxlQXR0YWNoVG9CdG4oJ2FkZC1uZXctYnV0dG9uJyxbJ3ppcCddLCBhZGROZXdFeHRlbnNpb24uY2JSZXN1bWFibGVVcGxvYWRGaWxlKTtcblx0fSxcblx0LyoqXG5cdCAqIFVwbG9hZCBmaWxlIGJ5IGNodW5rc1xuXHQgKiBAcGFyYW0gYWN0aW9uXG5cdCAqIEBwYXJhbSBwYXJhbXNcblx0ICovXG5cdGNiUmVzdW1hYmxlVXBsb2FkRmlsZShhY3Rpb24sIHBhcmFtcyl7XG5cdFx0c3dpdGNoIChhY3Rpb24pIHtcblx0XHRcdGNhc2UgJ2ZpbGVTdWNjZXNzJzpcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLmNoZWNrU3RhdHVzRmlsZU1lcmdpbmcocGFyYW1zLnJlc3BvbnNlKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICd1cGxvYWRTdGFydCc6XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi51cGxvYWRJblByb2dyZXNzID0gdHJ1ZTtcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24uYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiRwcm9ncmVzc0Jhci5zaG93KCk7XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkSW5Qcm9ncmVzcyk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAncHJvZ3Jlc3MnOlxuXHRcdFx0XHRhZGROZXdFeHRlbnNpb24uJHByb2dyZXNzQmFyLnByb2dyZXNzKHtcblx0XHRcdFx0XHRwZXJjZW50OiBwYXJzZUludChwYXJhbXMucGVyY2VudCwgMTApLFxuXHRcdFx0XHR9KTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICdlcnJvcic6XG5cdFx0XHRcdGFkZE5ld0V4dGVuc2lvbi4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuXHRcdFx0XHRhZGROZXdFeHRlbnNpb24uJHVwbG9hZEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHRVc2VyTWVzc2FnZS5zaG93RXJyb3IoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcik7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHR9XG5cdH0sXG5cdC8qKlxuXHQgKiBXYWl0IGZvciBmaWxlIHJlYWR5IHRvIHVzZVxuXHQgKlxuXHQgKiBAcGFyYW0gcmVzcG9uc2Ug0L7RgtCy0LXRgiDRhNGD0L3QutGG0LjQuCAvcGJ4Y29yZS9hcGkvdXBsb2FkL3N0YXR1c1xuXHQgKi9cblx0Y2hlY2tTdGF0dXNGaWxlTWVyZ2luZyhyZXNwb25zZSkge1xuXHRcdGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IFBieEFwaS50cnlQYXJzZUpTT04ocmVzcG9uc2UpID09PSBmYWxzZSkge1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd0Vycm9yKGAke2dsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3J9YCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKHJlc3BvbnNlKTtcblx0XHRpZiAoanNvbiA9PT0gdW5kZWZpbmVkIHx8IGpzb24uZGF0YSA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93RXJyb3IoYCR7Z2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcn1gKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Y29uc3QgZmlsZUlEID0ganNvbi5kYXRhLnVwbG9hZF9pZDtcblx0XHRjb25zdCBmaWxlUGF0aCA9IGpzb24uZGF0YS5maWxlbmFtZTtcblx0XHRtZXJnaW5nQ2hlY2tXb3JrZXIuaW5pdGlhbGl6ZShmaWxlSUQsIGZpbGVQYXRoKTtcblx0fSxcblxufTtcblxuY29uc3QgbWVyZ2luZ0NoZWNrV29ya2VyID0ge1xuXHR0aW1lT3V0OiAzMDAwLFxuXHR0aW1lT3V0SGFuZGxlOiAnJyxcblx0ZXJyb3JDb3VudHM6IDAsXG5cdCRwcm9ncmVzc0JhckxhYmVsOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhcicpLmZpbmQoJy5sYWJlbCcpLFxuXHRmaWxlSUQ6IG51bGwsXG5cdGZpbGVQYXRoOiAnJyxcblx0aW5pdGlhbGl6ZShmaWxlSUQsIGZpbGVQYXRoKSB7XG5cdFx0Ly8g0JfQsNC/0YPRgdGC0LjQvCDQvtCx0L3QvtCy0LvQtdC90LjQtSDRgdGC0LDRgtGD0YHQsCDQv9GA0L7QstCw0LnQtNC10YDQsFxuXHRcdG1lcmdpbmdDaGVja1dvcmtlci5maWxlSUQgPSBmaWxlSUQ7XG5cdFx0bWVyZ2luZ0NoZWNrV29ya2VyLmZpbGVQYXRoID0gZmlsZVBhdGg7XG5cdFx0bWVyZ2luZ0NoZWNrV29ya2VyLnJlc3RhcnRXb3JrZXIoZmlsZUlEKTtcblx0fSxcblx0cmVzdGFydFdvcmtlcigpIHtcblx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KG1lcmdpbmdDaGVja1dvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHRtZXJnaW5nQ2hlY2tXb3JrZXIud29ya2VyKCk7XG5cdH0sXG5cdHdvcmtlcigpIHtcblx0XHRQYnhBcGkuU3lzdGVtR2V0U3RhdHVzVXBsb2FkRmlsZShtZXJnaW5nQ2hlY2tXb3JrZXIuZmlsZUlELCBtZXJnaW5nQ2hlY2tXb3JrZXIuY2JBZnRlclJlc3BvbnNlKTtcblx0XHRtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuXHRcdFx0bWVyZ2luZ0NoZWNrV29ya2VyLndvcmtlcixcblx0XHRcdG1lcmdpbmdDaGVja1dvcmtlci50aW1lT3V0LFxuXHRcdCk7XG5cdH0sXG5cdGNiQWZ0ZXJSZXNwb25zZShyZXNwb25zZSkge1xuXHRcdGlmIChtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgPiAxMCkge1xuXHRcdFx0bWVyZ2luZ0NoZWNrV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcik7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93RXJyb3IocmVzcG9uc2UsIGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3IpO1xuXHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdHdpbmRvdy5jbGVhclRpbWVvdXQobWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdH1cblx0XHRpZiAocmVzcG9uc2UgPT09IHVuZGVmaW5lZCB8fCBPYmplY3Qua2V5cyhyZXNwb25zZSkubGVuZ3RoID09PSAwKSB7XG5cdFx0XHRtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgKz0gMTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0aWYgKHJlc3BvbnNlLmRfc3RhdHVzID09PSAnVVBMT0FEX0NPTVBMRVRFJykge1xuXHRcdFx0bWVyZ2luZ0NoZWNrV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsYXRpb25JblByb2dyZXNzKTtcblx0XHRcdFBieEFwaS5TeXN0ZW1JbnN0YWxsTW9kdWxlKG1lcmdpbmdDaGVja1dvcmtlci5maWxlUGF0aCwgbWVyZ2luZ0NoZWNrV29ya2VyLmNiQWZ0ZXJNb2R1bGVJbnN0YWxsKTtcblx0XHRcdHdpbmRvdy5jbGVhclRpbWVvdXQobWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdH0gZWxzZSBpZiAocmVzcG9uc2UuZF9zdGF0dXMgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0bWVyZ2luZ0NoZWNrV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRJblByb2dyZXNzKTtcblx0XHRcdG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyA9IDA7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyArPSAxO1xuXHRcdH1cblx0fSxcblx0Y2JBZnRlck1vZHVsZUluc3RhbGwocmVzcG9uc2Upe1xuXHRcdGlmIChyZXNwb25zZT09PXRydWUpe1xuXHRcdFx0d2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2UsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuXHRcdFx0YWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHR9XG5cdH0sXG59O1xuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG5cdGFkZE5ld0V4dGVuc2lvbi5pbml0aWFsaXplKCk7XG59KTtcbiJdfQ==