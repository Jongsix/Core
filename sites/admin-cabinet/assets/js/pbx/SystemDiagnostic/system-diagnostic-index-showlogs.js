"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global ace, PbxApi */
var updateLogViewWorker = {
  timeOut: 3000,
  timeOutHandle: '',
  errorCounts: 0,
  initialize: function () {
    function initialize() {
      updateLogViewWorker.restartWorker();
    }

    return initialize;
  }(),
  restartWorker: function () {
    function restartWorker() {
      window.clearTimeout(updateLogViewWorker.timeoutHandle);
      updateLogViewWorker.worker();
    }

    return restartWorker;
  }(),
  worker: function () {
    function worker() {
      systemDiagnosticLogs.updateLogFromServer();
      updateLogViewWorker.timeoutHandle = window.setTimeout(updateLogViewWorker.worker, updateLogViewWorker.timeOut);
    }

    return worker;
  }(),
  stop: function () {
    function stop() {
      window.clearTimeout(updateLogViewWorker.timeoutHandle);
    }

    return stop;
  }()
};
var systemDiagnosticLogs = {
  $showBtn: $('#show-last-log'),
  $downloadBtn: $('#download-file'),
  $showAutoBtn: $('#show-last-log-auto'),
  $logContent: $('#log-content-readonly'),
  viewer: '',
  $fileSelectDropDown: $('#system-diagnostic-form .filenames-select'),
  logsItems: [],
  defaultLogItem: null,
  $dimmer: $('#get-logs-dimmer'),
  $formObj: $('#system-diagnostic-form'),
  $fileName: $('#system-diagnostic-form .filename'),
  initialize: function () {
    function initialize() {
      var aceHeight = window.innerHeight - 250;
      systemDiagnosticLogs.$dimmer.closest('div').css('min-height', "".concat(aceHeight, "px"));
      systemDiagnosticLogs.$fileSelectDropDown.dropdown({
        values: systemDiagnosticLogs.logsItems,
        onChange: systemDiagnosticLogs.cbOnChangeFile,
        ignoreCase: true,
        fullTextSearch: true,
        forceSelection: false
      });
      systemDiagnosticLogs.initializeAce();
      PbxApi.SyslogGetLogsList(systemDiagnosticLogs.cbFormatDropdownResults);
      systemDiagnosticLogs.$showBtn.on('click', function (e) {
        e.preventDefault();
        systemDiagnosticLogs.updateLogFromServer();
      });
      systemDiagnosticLogs.$downloadBtn.on('click', function (e) {
        e.preventDefault();
        var data = systemDiagnosticLogs.$formObj.form('get values');
        PbxApi.SyslogDownloadLogFile(data.filename, systemDiagnosticLogs.cbDownloadFile);
      });
      systemDiagnosticLogs.$showAutoBtn.on('click', function (e) {
        e.preventDefault();
        var $reloadIcon = systemDiagnosticLogs.$showAutoBtn.find('i.refresh');

        if ($reloadIcon.hasClass('loading')) {
          $reloadIcon.removeClass('loading');
          updateLogViewWorker.stop();
        } else {
          $reloadIcon.addClass('loading');
          updateLogViewWorker.initialize();
        }
      });
      $('input').keyup(function (event) {
        if (event.keyCode === 13) {
          systemDiagnosticLogs.updateLogFromServer();
        }
      });
    }

    return initialize;
  }(),
  initializeAce: function () {
    function initializeAce() {
      var IniMode = ace.require('ace/mode/julia').Mode;

      systemDiagnosticLogs.viewer = ace.edit('log-content-readonly');
      systemDiagnosticLogs.viewer.session.setMode(new IniMode());
      systemDiagnosticLogs.viewer.setTheme('ace/theme/monokai');
      systemDiagnosticLogs.viewer.renderer.setShowGutter(false);
      systemDiagnosticLogs.viewer.setOptions({
        showLineNumbers: false,
        showPrintMargin: false,
        readOnly: true
      });
      $(window).load(function () {
        var aceHeight = window.innerHeight - systemDiagnosticLogs.$logContent.offset().top - 50;
        $('.log-content-readonly').css('min-height', "".concat(aceHeight, "px"));
        systemDiagnosticLogs.viewer.resize();
      });
    }

    return initializeAce;
  }(),

  /**
   * Makes formatted menu structure
   */
  cbFormatDropdownResults: function () {
    function cbFormatDropdownResults(response) {
      if (response === false) {
        return;
      }

      systemDiagnosticLogs.logsItems = [];
      var files = response.files;
      $.each(files, function (index, item) {
        systemDiagnosticLogs.logsItems.push({
          name: "".concat(index, " (").concat(item.size, ")"),
          value: item.path,
          selected: item["default"]
        });
      });
      systemDiagnosticLogs.$fileSelectDropDown.dropdown('change values', systemDiagnosticLogs.logsItems);
    }

    return cbFormatDropdownResults;
  }(),

  /**
   * Callback after change log file in select
   * @param value
   */
  cbOnChangeFile: function () {
    function cbOnChangeFile(value) {
      if (value.length === 0) {
        return;
      }

      systemDiagnosticLogs.$formObj.form('set value', 'filename', value);
      systemDiagnosticLogs.updateLogFromServer();
    }

    return cbOnChangeFile;
  }(),

  /**
   * Asks log file content from server
   */
  updateLogFromServer: function () {
    function updateLogFromServer() {
      var params = systemDiagnosticLogs.$formObj.form('get values');
      PbxApi.SyslogGetLogFromFile(params, systemDiagnosticLogs.cbUpdateLogText);
    }

    return updateLogFromServer;
  }(),

  /**
   * Updates log view
   * @param data
   */
  cbUpdateLogText: function () {
    function cbUpdateLogText(data) {
      systemDiagnosticLogs.viewer.getSession().setValue(data.content);
      var row = systemDiagnosticLogs.viewer.session.getLength() - 1;
      var column = systemDiagnosticLogs.viewer.session.getLine(row).length; // or simply Infinity

      systemDiagnosticLogs.viewer.gotoLine(row + 1, column);
      systemDiagnosticLogs.$dimmer.removeClass('active');
    }

    return cbUpdateLogText;
  }(),

  /**
   * After push button download file
   * @param response
   */
  cbDownloadFile: function () {
    function cbDownloadFile(response) {
      if (response !== false) {
        window.location = response.filename;
      }
    }

    return cbDownloadFile;
  }()
};
$(document).ready(function () {
  systemDiagnosticLogs.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TeXN0ZW1EaWFnbm9zdGljL3N5c3RlbS1kaWFnbm9zdGljLWluZGV4LXNob3dsb2dzLmpzIl0sIm5hbWVzIjpbInVwZGF0ZUxvZ1ZpZXdXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImVycm9yQ291bnRzIiwiaW5pdGlhbGl6ZSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwic3lzdGVtRGlhZ25vc3RpY0xvZ3MiLCJ1cGRhdGVMb2dGcm9tU2VydmVyIiwic2V0VGltZW91dCIsInN0b3AiLCIkc2hvd0J0biIsIiQiLCIkZG93bmxvYWRCdG4iLCIkc2hvd0F1dG9CdG4iLCIkbG9nQ29udGVudCIsInZpZXdlciIsIiRmaWxlU2VsZWN0RHJvcERvd24iLCJsb2dzSXRlbXMiLCJkZWZhdWx0TG9nSXRlbSIsIiRkaW1tZXIiLCIkZm9ybU9iaiIsIiRmaWxlTmFtZSIsImFjZUhlaWdodCIsImlubmVySGVpZ2h0IiwiY2xvc2VzdCIsImNzcyIsImRyb3Bkb3duIiwidmFsdWVzIiwib25DaGFuZ2UiLCJjYk9uQ2hhbmdlRmlsZSIsImlnbm9yZUNhc2UiLCJmdWxsVGV4dFNlYXJjaCIsImZvcmNlU2VsZWN0aW9uIiwiaW5pdGlhbGl6ZUFjZSIsIlBieEFwaSIsIlN5c2xvZ0dldExvZ3NMaXN0IiwiY2JGb3JtYXREcm9wZG93blJlc3VsdHMiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImRhdGEiLCJmb3JtIiwiU3lzbG9nRG93bmxvYWRMb2dGaWxlIiwiZmlsZW5hbWUiLCJjYkRvd25sb2FkRmlsZSIsIiRyZWxvYWRJY29uIiwiZmluZCIsImhhc0NsYXNzIiwicmVtb3ZlQ2xhc3MiLCJhZGRDbGFzcyIsImtleXVwIiwiZXZlbnQiLCJrZXlDb2RlIiwiSW5pTW9kZSIsImFjZSIsInJlcXVpcmUiLCJNb2RlIiwiZWRpdCIsInNlc3Npb24iLCJzZXRNb2RlIiwic2V0VGhlbWUiLCJyZW5kZXJlciIsInNldFNob3dHdXR0ZXIiLCJzZXRPcHRpb25zIiwic2hvd0xpbmVOdW1iZXJzIiwic2hvd1ByaW50TWFyZ2luIiwicmVhZE9ubHkiLCJsb2FkIiwib2Zmc2V0IiwidG9wIiwicmVzaXplIiwicmVzcG9uc2UiLCJmaWxlcyIsImVhY2giLCJpbmRleCIsIml0ZW0iLCJwdXNoIiwibmFtZSIsInNpemUiLCJ2YWx1ZSIsInBhdGgiLCJzZWxlY3RlZCIsImxlbmd0aCIsInBhcmFtcyIsIlN5c2xvZ0dldExvZ0Zyb21GaWxlIiwiY2JVcGRhdGVMb2dUZXh0IiwiZ2V0U2Vzc2lvbiIsInNldFZhbHVlIiwiY29udGVudCIsInJvdyIsImdldExlbmd0aCIsImNvbHVtbiIsImdldExpbmUiLCJnb3RvTGluZSIsImxvY2F0aW9uIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBO0FBR0EsSUFBTUEsbUJBQW1CLEdBQUc7QUFDM0JDLEVBQUFBLE9BQU8sRUFBRSxJQURrQjtBQUUzQkMsRUFBQUEsYUFBYSxFQUFFLEVBRlk7QUFHM0JDLEVBQUFBLFdBQVcsRUFBRSxDQUhjO0FBSTNCQyxFQUFBQSxVQUoyQjtBQUFBLDBCQUlkO0FBQ1pKLE1BQUFBLG1CQUFtQixDQUFDSyxhQUFwQjtBQUNBOztBQU4wQjtBQUFBO0FBTzNCQSxFQUFBQSxhQVAyQjtBQUFBLDZCQU9YO0FBQ2ZDLE1BQUFBLE1BQU0sQ0FBQ0MsWUFBUCxDQUFvQlAsbUJBQW1CLENBQUNRLGFBQXhDO0FBQ0FSLE1BQUFBLG1CQUFtQixDQUFDUyxNQUFwQjtBQUNBOztBQVYwQjtBQUFBO0FBVzNCQSxFQUFBQSxNQVgyQjtBQUFBLHNCQVdsQjtBQUNSQyxNQUFBQSxvQkFBb0IsQ0FBQ0MsbUJBQXJCO0FBQ0FYLE1BQUFBLG1CQUFtQixDQUFDUSxhQUFwQixHQUFvQ0YsTUFBTSxDQUFDTSxVQUFQLENBQ25DWixtQkFBbUIsQ0FBQ1MsTUFEZSxFQUVuQ1QsbUJB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OztBQUlBSixFQUFBQSxjQTNINEI7QUFBQSw0QkEySGIyQixRQTNIYSxFQTJISjtBQUN2QixVQUFJQSxRQUFRLEtBQUcsS0FBZixFQUFxQjtBQUNwQnJFLFFBQUFBLE1BQU0sQ0FBQzRGLFFBQVAsR0FBa0J2QixRQUFRLENBQUM1QixRQUEzQjtBQUNBO0FBQ0Q7O0FBL0gyQjtBQUFBO0FBQUEsQ0FBN0I7QUFrSUFoQyxDQUFDLENBQUNvRixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3ZCMUYsRUFBQUEsb0JBQW9CLENBQUNOLFVBQXJCO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTctMjAyMCBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuLyogZ2xvYmFsIGFjZSwgUGJ4QXBpICovXG5cblxuY29uc3QgdXBkYXRlTG9nVmlld1dvcmtlciA9IHtcblx0dGltZU91dDogMzAwMCxcblx0dGltZU91dEhhbmRsZTogJycsXG5cdGVycm9yQ291bnRzOiAwLFxuXHRpbml0aWFsaXplKCkge1xuXHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuXHR9LFxuXHRyZXN0YXJ0V29ya2VyKCkge1xuXHRcdHdpbmRvdy5jbGVhclRpbWVvdXQodXBkYXRlTG9nVmlld1dvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLndvcmtlcigpO1xuXHR9LFxuXHR3b3JrZXIoKSB7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MudXBkYXRlTG9nRnJvbVNlcnZlcigpO1xuXHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuXHRcdFx0dXBkYXRlTG9nVmlld1dvcmtlci53b3JrZXIsXG5cdFx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLnRpbWVPdXQsXG5cdFx0KTtcblx0fSxcblx0c3RvcCgpIHtcblx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZGF0ZUxvZ1ZpZXdXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdH1cbn07XG5cbmNvbnN0IHN5c3RlbURpYWdub3N0aWNMb2dzID0ge1xuXHQkc2hvd0J0bjogJCgnI3Nob3ctbGFzdC1sb2cnKSxcblx0JGRvd25sb2FkQnRuOiAkKCcjZG93bmxvYWQtZmlsZScpLFxuXHQkc2hvd0F1dG9CdG46ICQoJyNzaG93LWxhc3QtbG9nLWF1dG8nKSxcblx0JGxvZ0NvbnRlbnQ6ICQoJyNsb2ctY29udGVudC1yZWFkb25seScpLFxuXHR2aWV3ZXI6ICcnLFxuXHQkZmlsZVNlbGVjdERyb3BEb3duOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybSAuZmlsZW5hbWVzLXNlbGVjdCcpLFxuXHRsb2dzSXRlbXM6IFtdLFxuXHRkZWZhdWx0TG9nSXRlbTogbnVsbCxcblx0JGRpbW1lcjogJCgnI2dldC1sb2dzLWRpbW1lcicpLFxuXHQkZm9ybU9iajogJCgnI3N5c3RlbS1kaWFnbm9zdGljLWZvcm0nKSxcblx0JGZpbGVOYW1lOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybSAuZmlsZW5hbWUnKSxcblx0aW5pdGlhbGl6ZSgpIHtcblx0XHRjb25zdCBhY2VIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQtMjUwO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRkaW1tZXIuY2xvc2VzdCgnZGl2JykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZpbGVTZWxlY3REcm9wRG93bi5kcm9wZG93bihcblx0XHRcdHtcblx0XHRcdFx0dmFsdWVzOiBzeXN0ZW1EaWFnbm9zdGljTG9ncy5sb2dzSXRlbXMsXG5cdFx0XHRcdG9uQ2hhbmdlOiBzeXN0ZW1EaWFnbm9zdGljTG9ncy5jYk9uQ2hhbmdlRmlsZSxcblx0XHRcdFx0aWdub3JlQ2FzZTogdHJ1ZSxcblx0XHRcdFx0ZnVsbFRleHRTZWFyY2g6IHRydWUsXG5cdFx0XHRcdGZvcmNlU2VsZWN0aW9uOiBmYWxzZSxcblx0XHRcdH1cblx0XHQpO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLmluaXRpYWxpemVBY2UoKTtcblx0XHRQYnhBcGkuU3lzbG9nR2V0TG9nc0xpc3Qoc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JGb3JtYXREcm9wZG93blJlc3VsdHMpO1xuXG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJHNob3dCdG4ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnVwZGF0ZUxvZ0Zyb21TZXJ2ZXIoKTtcblx0XHR9KTtcblxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRkb3dubG9hZEJ0bi5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0Y29uc3QgZGF0YSA9IHN5c3RlbURpYWdub3N0aWNMb2dzLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcblx0XHRcdFBieEFwaS5TeXNsb2dEb3dubG9hZExvZ0ZpbGUoZGF0YS5maWxlbmFtZSwgc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JEb3dubG9hZEZpbGUpO1xuXHRcdH0pO1xuXG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJHNob3dBdXRvQnRuLm9uKCdjbGljaycsIChlKSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRjb25zdCAkcmVsb2FkSWNvbiA9IHN5c3RlbURpYWdub3N0aWNMb2dzLiRzaG93QXV0b0J0bi5maW5kKCdpLnJlZnJlc2gnKTtcblx0XHRcdGlmICgkcmVsb2FkSWNvbi5oYXNDbGFzcygnbG9hZGluZycpKXtcblx0XHRcdFx0JHJlbG9hZEljb24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0dXBkYXRlTG9nVmlld1dvcmtlci5zdG9wKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHQkcmVsb2FkSWNvbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLmluaXRpYWxpemUoKTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHQkKCdpbnB1dCcpLmtleXVwKChldmVudCk9PiB7XG5cdFx0XHRpZiAoZXZlbnQua2V5Q29kZSA9PT0gMTMpIHtcblx0XHRcdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MudXBkYXRlTG9nRnJvbVNlcnZlcigpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9LFxuXHRpbml0aWFsaXplQWNlKCkge1xuXHRcdGNvbnN0IEluaU1vZGUgPSBhY2UucmVxdWlyZSgnYWNlL21vZGUvanVsaWEnKS5Nb2RlO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlciA9IGFjZS5lZGl0KCdsb2ctY29udGVudC1yZWFkb25seScpO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXNzaW9uLnNldE1vZGUobmV3IEluaU1vZGUoKSk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnNldFRoZW1lKCdhY2UvdGhlbWUvbW9ub2thaScpO1xuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5yZW5kZXJlci5zZXRTaG93R3V0dGVyKGZhbHNlKTtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2V0T3B0aW9ucyh7XG5cdFx0XHRzaG93TGluZU51bWJlcnM6ZmFsc2UsXG5cdFx0XHRzaG93UHJpbnRNYXJnaW46IGZhbHNlLFxuXHRcdFx0cmVhZE9ubHk6IHRydWUsXG5cdFx0fSk7XG5cdFx0JCh3aW5kb3cpLmxvYWQoZnVuY3Rpb24oKSB7XG5cdFx0XHRjb25zdCBhY2VIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQtc3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGxvZ0NvbnRlbnQub2Zmc2V0KCkudG9wLTUwO1xuXHRcdFx0JCgnLmxvZy1jb250ZW50LXJlYWRvbmx5JykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG5cdFx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIucmVzaXplKCk7XG5cdFx0fSk7XG5cdH0sXG5cdC8qKlxuXHQgKiBNYWtlcyBmb3JtYXR0ZWQgbWVudSBzdHJ1Y3R1cmVcblx0ICovXG5cdGNiRm9ybWF0RHJvcGRvd25SZXN1bHRzKHJlc3BvbnNlKSB7XG5cdFx0aWYgKHJlc3BvbnNlID09PWZhbHNlKXtcblx0XHRcdHJldHVybiA7XG5cdFx0fVxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLmxvZ3NJdGVtcyA9IFtdO1xuXHRcdGNvbnN0IGZpbGVzID0gcmVzcG9uc2UuZmlsZXM7XG5cdFx0JC5lYWNoKGZpbGVzLCAoaW5kZXgsIGl0ZW0pID0+IHtcblx0XHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLmxvZ3NJdGVtcy5wdXNoKHtcblx0XHRcdFx0bmFtZTogYCR7aW5kZXh9ICgke2l0ZW0uc2l6ZX0pYCxcblx0XHRcdFx0dmFsdWU6IGl0ZW0ucGF0aCxcblx0XHRcdFx0c2VsZWN0ZWQ6IGl0ZW0uZGVmYXVsdFxuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZpbGVTZWxlY3REcm9wRG93bi5kcm9wZG93bignY2hhbmdlIHZhbHVlcycsIHN5c3RlbURpYWdub3N0aWNMb2dzLmxvZ3NJdGVtcyk7XG5cdH0sXG5cdC8qKlxuXHQgKiBDYWxsYmFjayBhZnRlciBjaGFuZ2UgbG9nIGZpbGUgaW4gc2VsZWN0XG5cdCAqIEBwYXJhbSB2YWx1ZVxuXHQgKi9cblx0Y2JPbkNoYW5nZUZpbGUodmFsdWUpIHtcblx0XHRpZiAodmFsdWUubGVuZ3RoPT09MCl7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRmb3JtT2JqLmZvcm0oJ3NldCB2YWx1ZScsICdmaWxlbmFtZScsIHZhbHVlKTtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy51cGRhdGVMb2dGcm9tU2VydmVyKCk7XG5cdH0sXG5cdC8qKlxuXHQgKiBBc2tzIGxvZyBmaWxlIGNvbnRlbnQgZnJvbSBzZXJ2ZXJcblx0ICovXG5cdHVwZGF0ZUxvZ0Zyb21TZXJ2ZXIoKXtcblx0XHRjb25zdCBwYXJhbXMgPSBzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG5cdFx0UGJ4QXBpLlN5c2xvZ0dldExvZ0Zyb21GaWxlKHBhcmFtcywgc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JVcGRhdGVMb2dUZXh0KTtcblx0fSxcblx0LyoqXG5cdCAqIFVwZGF0ZXMgbG9nIHZpZXdcblx0ICogQHBhcmFtIGRhdGFcblx0ICovXG5cdGNiVXBkYXRlTG9nVGV4dChkYXRhKSB7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLmdldFNlc3Npb24oKS5zZXRWYWx1ZShkYXRhLmNvbnRlbnQpO1xuXHRcdGNvbnN0IHJvdyA9IHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXNzaW9uLmdldExlbmd0aCgpIC0gMTtcblx0XHRjb25zdCBjb2x1bW4gPSBzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2Vzc2lvbi5nZXRMaW5lKHJvdykubGVuZ3RoOyAvLyBvciBzaW1wbHkgSW5maW5pdHlcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuZ290b0xpbmUocm93ICsgMSwgY29sdW1uKTtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZGltbWVyLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcblx0fSxcblx0LyoqXG5cdCAqIEFmdGVyIHB1c2ggYnV0dG9uIGRvd25sb2FkIGZpbGVcblx0ICogQHBhcmFtIHJlc3BvbnNlXG5cdCAqL1xuXHRjYkRvd25sb2FkRmlsZShyZXNwb25zZSl7XG5cdFx0aWYgKHJlc3BvbnNlIT09ZmFsc2Upe1xuXHRcdFx0d2luZG93LmxvY2F0aW9uID0gcmVzcG9uc2UuZmlsZW5hbWU7XG5cdFx0fVxuXHR9LFxufTtcblxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuXHRzeXN0ZW1EaWFnbm9zdGljTG9ncy5pbml0aWFsaXplKCk7XG59KTtcblxuIl19