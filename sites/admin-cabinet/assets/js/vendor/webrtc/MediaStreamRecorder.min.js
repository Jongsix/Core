"use strict";function MediaStreamRecorder(mediaStream){if(!mediaStream){throw"MediaStream is mandatory."}this.start=function(timeSlice){var Recorder;if(typeof MediaRecorder!=="undefined"){Recorder=MediaRecorderWrapper}else if(IsChrome||IsOpera||IsEdge){if(this.mimeType.indexOf("video")!==-1){Recorder=WhammyRecorder}else if(this.mimeType.indexOf("audio")!==-1){Recorder=StereoAudioRecorder}}if(this.mimeType==="image/gif"){Recorder=GifRecorder}if(this.mimeType==="audio/wav"||this.mimeType==="audio/pcm"){Recorder=StereoAudioRecorder}if(this.recorderType){Recorder=this.recorderType}mediaRecorder=new Recorder(mediaStream);mediaRecorder.blobs=[];var self=this;mediaRecorder.ondataavailable=function(data){mediaRecorder.blobs.push(data);self.ondataavailable(data)};mediaRecorder.onstop=this.onstop;mediaRecorder.onStartedDrawingNonBlankFrames=this.onStartedDrawingNonBlankFrames;mediaRecorder=mergeProps(mediaRecorder,this);mediaRecorder.start(timeSlice)};this.onStartedDrawingNonBlankFrames=function(){};this.clearOldRecordedFrames=function(){if(!mediaRecorder){return}mediaRecorder.clearOldRecordedFrames()};this.stop=function(){if(mediaRecorder){mediaRecorder.stop()}};this.ondataavailable=function(blob){if(this.disableLogs)return;console.log("ondataavailable..",blob)};this.onstop=function(error){console.warn("stopped..",error)};this.save=function(file,fileName){if(!file){if(!mediaRecorder){return}ConcatenateBlobs(mediaRecorder.blobs,mediaRecorder.blobs[0].type,function(concatenatedBlob){invokeSaveAsDialog(concatenatedBlob)});return}invokeSaveAsDialog(file,fileName)};this.pause=function(){if(!mediaRecorder){return}mediaRecorder.pause();if(this.disableLogs)return;console.log("Paused recording.",this.mimeType||mediaRecorder.mimeType)};this.resume=function(){if(!mediaRecorder){return}mediaRecorder.resume();if(this.disableLogs)return;console.log("Resumed recording.",this.mimeType||mediaRecorder.mimeType)};this.recorderType=null;this.mimeType="video/webm";this.disableLogs=false;var mediaRecorder}function MultiStreamRecorder(arrayOfMediaStreams,options){arrayOfMediaStreams=arrayOfMediaStreams||[];if(arrayOfMediaStreams instanceof MediaStream){arrayOfMediaStreams=[arrayOfMediaStreams]}var self=this;var mixer;var mediaRecorder;options=options||{mimeType:"video/webm",video:{width:360,height:240}};if(!options.frameInterval){options.frameInterval=10}if(!options.video){options.video={}}if(!options.video.width){options.video.width=360}if(!options.video.height){options.video.height=240}this.start=function(timeSlice){mixer=new MultiStreamsMixer(arrayOfMediaStreams);if(getVideoTracks().length){mixer.frameInterval=options.frameInterval||10;mixer.width=options.video.width||360;mixer.height=options.video.height||240;mixer.startDrawingFrames()}if(typeof self.previewStream==="function"){self.previewStream(mixer.getMixedStream())}mediaRecorder=new MediaStreamRecorder(mixer.getMixedStream());for(var prop in self){if(typeof self[prop]!=="function"){mediaRecorder[prop]=self[prop]}}mediaRecorder.ondataavailable=function(blob){self.ondataavailable(blob)};mediaRecorder.onstop=self.onstop;mediaRecorder.start(timeSlice)};function getVideoTracks(){var tracks=[];arrayOfMediaStreams.forEach(function(stream){stream.getVideoTracks().forEach(function(track){tracks.push(track)})});return tracks}this.stop=function(callback){if(!mediaRecorder){return}mediaRecorder.stop(function(blob){callback(blob)})};this.pause=function(){if(mediaRecorder){mediaRecorder.pause()}};this.resume=function(){if(mediaRecorder){mediaRecorder.resume()}};this.clearRecordedData=function(){if(mediaRecorder){mediaRecorder.clearRecordedData();mediaRecorder=null}if(mixer){mixer.releaseStreams();mixer=null}};this.addStreams=this.addStream=function(streams){if(!streams){throw"First parameter is required."}if(!(streams instanceof Array)){streams=[streams]}arrayOfMediaStreams.concat(streams);if(!mediaRecorder||!mixer){return}mixer.appendStreams(streams)};this.resetVideoStreams=function(streams){if(!mixer){return}if(streams&&!(streams instanceof Array)){streams=[streams]}mixer.resetVideoStreams(streams)};this.ondataavailable=function(blob){if(self.disableLogs){return}console.log("ondataavailable",blob)};this.onstop=function(){};this.name="MultiStreamRecorder";this.toString=function(){return this.name}}if(typeof MediaStreamRecorder!=="undefined"){MediaStreamRecorder.MultiStreamRecorder=MultiStreamRecorder}function MultiStreamsMixer(arrayOfMediaStreams){var videos=[];var isStopDrawingFrames=false;var canvas=document.createElement("canvas");var context=canvas.getContext("2d");canvas.style="opacity:0;position:absolute;z-index:-1;top: -100000000;left:-1000000000; margin-top:-1000000000;margin-left:-1000000000;";(document.body||document.documentElement).appendChild(canvas);this.disableLogs=false;this.frameInterval=10;this.width=360;this.height=240;this.useGainNode=true;var self=this;var AudioContext=window.AudioContext;if(typeof AudioContext==="undefined"){if(typeof webkitAudioContext!=="undefined"){AudioContext=webkitAudioContext}if(typeof mozAudioContext!=="undefined"){AudioContext=mozAudioContext}}var URL=window.URL;if(typeof URL==="undefined"&&typeof webkitURL!=="undefined"){URL=webkitURL}if(typeof navigator!=="undefined"&&typeof navigator.getUserMedia==="undefined"){if(typeof navigator.webkitGetUserMedia!=="undefined"){navigator.getUserMedia=navigator.webkitGetUserMedia}if(typeof navigator.mozGetUserMedia!=="undefined"){navigator.getUserMedia=navigator.mozGetUserMedia}}var MediaStream=window.MediaStream;if(typeof MediaStream==="undefined"&&typeof webkitMediaStream!=="undefined"){MediaStream=webkitMediaStream}if(typeof MediaStream!=="undefined"){if(!("getVideoTracks"in MediaStream.prototype)){MediaStream.prototype.getVideoTracks=function(){if(!this.getTracks){return[]}var tracks=[];this.getTracks.forEach(function(track){if(track.kind.toString().indexOf("video")!==-1){tracks.push(track)}});return tracks};MediaStream.prototype.getAudioTracks=function(){if(!this.getTracks){return[]}var tracks=[];this.getTracks.forEach(function(track){if(track.kind.toString().indexOf("audio")!==-1){tracks.push(track)}});return tracks}}if(typeof MediaStream.prototype.stop==="undefined"){MediaStream.prototype.stop=function(){this.getTracks().forEach(function(track){track.stop()})}}}var Storage={};if(typeof AudioContext!=="undefined"){Storage.AudioContext=AudioContext}else if(typeof webkitAudioContext!=="undefined"){Storage.AudioContext=webkitAudioContext}this.startDrawingFrames=function(){drawVideosToCanvas()};function drawVideosToCanvas(){if(isStopDrawingFrames){return}var videosLength=videos.length;var fullcanvas=false;var remaining=[];videos.forEach(function(video){if(!video.stream){video.stream={}}if(video.stream.fullcanvas){fullcanvas=video}else{remaining.push(video)}});if(fullcanvas){canvas.width=fullcanvas.stream.width;canvas.height=fullcanvas.stream.height}else if(remaining.length){canvas.width=videosLength>1?remaining[0].width*2:remaining[0].width;canvas.height=videosLength>2?remaining[0].height*2:remaining[0].height}else{canvas.width=self.width||360;canvas.height=self.height||240}if(fullcanvas&&fullcanvas instanceof HTMLVideoElement){drawImage(fullcanvas)}remaining.forEach(function(video,idx){drawImage(video,idx)});setTimeout(drawVideosToCanvas,self.frameInterval)}function drawImage(video,idx){if(isStopDrawingFrames){return}var x=0;var y=0;var width=video.width;var height=video.height;if(idx===1){x=video.width}if(idx===2){y=video.height}if(idx===3){x=video.width;y=video.height}if(typeof video.stream.left!=="undefined"){x=video.stream.left}if(typeof video.stream.top!=="undefined"){y=video.stream.top}if(typeof video.stream.width!=="undefined"){width=video.stream.width}if(typeof video.stream.height!=="undefined"){height=video.stream.height}context.drawImage(video,x,y,width,height);if(typeof video.stream.onRender==="function"){video.stream.onRender(context,x,y,width,height,idx)}}function getMixedStream(){isStopDrawingFrames=false;var mixedVideoStream=getMixedVideoStream();var mixedAudioStream=getMixedAudioStream();if(mixedAudioStream){mixedAudioStream.getAudioTracks().forEach(function(track){mixedVideoStream.addTrack(track)})}var fullcanvas;arrayOfMediaStreams.forEach(function(stream){if(stream.fullcanvas){fullcanvas=true}});return mixedVideoStream}function getMixedVideoStream(){resetVideoStreams();var capturedStream;if("captureStream"in canvas){capturedStream=canvas.captureStream()}else if("mozCaptureStream"in canvas){capturedStream=canvas.mozCaptureStream()}else if(!self.disableLogs){console.error("Upgrade to latest Chrome or otherwise enable this flag: chrome://flags/#enable-experimental-web-platform-features")}var videoStream=new MediaStream;capturedStream.getVideoTracks().forEach(function(track){videoStream.addTrack(track)});canvas.stream=videoStream;return videoStream}function getMixedAudioStream(){if(!Storage.AudioContextConstructor){Storage.AudioContextConstructor=new Storage.AudioContext}self.audioContext=Storage.AudioContextConstructor;self.audioSources=[];if(self.useGainNode===true){self.gainNode=self.audioContext.createGain();self.gainNode.connect(self.audioContext.destination);self.gainNode.gain.value=0}var audioTracksLength=0;arrayOfMediaStreams.forEach(function(stream){if(!stream.getAudioTracks().length){return}audioTracksLength++;var audioSource=self.audioContext.createMediaStreamSource(stream);if(self.useGainNode===true){audioSource.connect(self.gainNode)}self.audioSources.push(audioSource)});if(!audioTracksLength){return}self.audioDestination=self.audioContext.createMediaStreamDestination();self.audioSources.forEach(function(audioSource){audioSource.connect(self.audioDestination)});return self.audioDestination.stream}function getVideo(stream){var video=document.createElement("video");if("srcObject"in video){video.srcObject=stream}else{video.src=URL.createObjectURL(stream)}video.muted=true;video.volume=0;video.width=stream.width||self.width||360;video.height=stream.height||self.height||240;video.play();return video}this.appendStreams=function(streams){if(!streams){throw"First parameter is required."}if(!(streams instanceof Array)){streams=[streams]}arrayOfMediaStreams.concat(streams);streams.forEach(function(stream){if(stream.getVideoTracks().length){var video=getVideo(stream);video.stream=stream;videos.push(video)}if(stream.getAudioTracks().length&&self.audioContext){var audioSource=self.audioContext.createMediaStreamSource(stream);audioSource.connect(self.audioDestination);self.audioSources.push(audioSource)}})};this.releaseStreams=function(){videos=[];isStopDrawingFrames=true;if(self.gainNode){self.gainNode.disconnect();self.gainNode=null}if(self.audioSources.length){self.audioSources.forEach(function(source){source.disconnect()});self.audioSources=[]}if(self.audioDestination){self.audioDestination.disconnect();self.audioDestination=null}self.audioContext=null;context.clearRect(0,0,canvas.width,canvas.height);if(canvas.stream){canvas.stream.stop();canvas.stream=null}};this.resetVideoStreams=function(streams){if(streams&&!(streams instanceof Array)){streams=[streams]}resetVideoStreams(streams)};function resetVideoStreams(streams){videos=[];streams=streams||arrayOfMediaStreams;streams.forEach(function(stream){if(!stream.getVideoTracks().length){return}var video=getVideo(stream);video.stream=stream;videos.push(video)})}this.name="MultiStreamsMixer";this.toString=function(){return this.name};this.getMixedStream=getMixedStream}var browserFakeUserAgent="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";(function(that){if(typeof window!=="undefined"){return}if(typeof window==="undefined"&&typeof global!=="undefined"){global.navigator={userAgent:browserFakeUserAgent,getUserMedia:function(){}};that.window=global}else if(typeof window==="undefined"){}if(typeof document==="undefined"){that.document={};document.createElement=document.captureStream=document.mozCaptureStream=function(){return{}}}if(typeof location==="undefined"){that.location={protocol:"file:",href:"",hash:""}}if(typeof screen==="undefined"){that.screen={width:0,height:0}}})(typeof global!=="undefined"?global:window);var AudioContext=window.AudioContext;if(typeof AudioContext==="undefined"){if(typeof webkitAudioContext!=="undefined"){AudioContext=webkitAudioContext}if(typeof mozAudioContext!=="undefined"){AudioContext=mozAudioContext}}if(typeof window==="undefined"){window={}}var AudioContext=window.AudioContext;if(typeof AudioContext==="undefined"){if(typeof webkitAudioContext!=="undefined"){AudioContext=webkitAudioContext}if(typeof mozAudioContext!=="undefined"){AudioContext=mozAudioContext}}var URL=window.URL;if(typeof URL==="undefined"&&typeof webkitURL!=="undefined"){URL=webkitURL}if(typeof navigator!=="undefined"){if(typeof navigator.webkitGetUserMedia!=="undefined"){navigator.getUserMedia=navigator.webkitGetUserMedia}if(typeof navigator.mozGetUserMedia!=="undefined"){navigator.getUserMedia=navigator.mozGetUserMedia}}else{navigator={getUserMedia:function(){},userAgent:browserFakeUserAgent}}var IsEdge=navigator.userAgent.indexOf("Edge")!==-1&&(!!navigator.msSaveBlob||!!navigator.msSaveOrOpenBlob);var IsOpera=false;if(typeof opera!=="undefined"&&navigator.userAgent&&navigator.userAgent.indexOf("OPR/")!==-1){IsOpera=true}var IsChrome=!IsEdge&&!IsEdge&&!!navigator.webkitGetUserMedia;var MediaStream=window.MediaStream;if(typeof MediaStream==="undefined"&&typeof webkitMediaStream!=="undefined"){MediaStream=webkitMediaStream}if(typeof MediaStream!=="undefined"){if(!("getVideoTracks"in MediaStream.prototype)){MediaStream.prototype.getVideoTracks=function(){if(!this.getTracks){return[]}var tracks=[];this.getTracks.forEach(function(track){if(track.kind.toString().indexOf("video")!==-1){tracks.push(track)}});return tracks};MediaStream.prototype.getAudioTracks=function(){if(!this.getTracks){return[]}var tracks=[];this.getTracks.forEach(function(track){if(track.kind.toString().indexOf("audio")!==-1){tracks.push(track)}});return tracks}}if(!("stop"in MediaStream.prototype)){MediaStream.prototype.stop=function(){this.getAudioTracks().forEach(function(track){if(!!track.stop){track.stop()}});this.getVideoTracks().forEach(function(track){if(!!track.stop){track.stop()}})}}}if(typeof location!=="undefined"){if(location.href.indexOf("file:")===0){console.error("Please load this HTML file on HTTP or HTTPS.")}}function mergeProps(mergein,mergeto){for(var t in mergeto){if(typeof mergeto[t]!=="function"){mergein[t]=mergeto[t]}}return mergein}function dropFirstFrame(arr){arr.shift();return arr}function invokeSaveAsDialog(file,fileName){if(!file){throw"Blob object is required."}if(!file.type){try{file.type="video/webm"}catch(e){}}var fileExtension=(file.type||"video/webm").split("/")[1];if(fileName&&fileName.indexOf(".")!==-1){var splitted=fileName.split(".");fileName=splitted[0];fileExtension=splitted[1]}var fileFullName=(fileName||Math.round(Math.random()*9999999999)+888888888)+"."+fileExtension;if(typeof navigator.msSaveOrOpenBlob!=="undefined"){return navigator.msSaveOrOpenBlob(file,fileFullName)}else if(typeof navigator.msSaveBlob!=="undefined"){return navigator.msSaveBlob(file,fileFullName)}var hyperlink=document.createElement("a");hyperlink.href=URL.createObjectURL(file);hyperlink.target="_blank";hyperlink.download=fileFullName;if(!!navigator.mozGetUserMedia){hyperlink.onclick=function(){(document.body||document.documentElement).removeChild(hyperlink)};(document.body||document.documentElement).appendChild(hyperlink)}var evt=new MouseEvent("click",{view:window,bubbles:true,cancelable:true});hyperlink.dispatchEvent(evt);if(!navigator.mozGetUserMedia){URL.revokeObjectURL(hyperlink.href)}}function bytesToSize(bytes){var k=1e3;var sizes=["Bytes","KB","MB","GB","TB"];if(bytes===0){return"0 Bytes"}var i=parseInt(Math.floor(Math.log(bytes)/Math.log(k)),10);return(bytes/Math.pow(k,i)).toPrecision(3)+" "+sizes[i]}var ObjectStore={AudioContext:AudioContext};function isMediaRecorderCompatible(){var isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0;var isChrome=!!window.chrome&&!isOpera;var isFirefox=typeof window.InstallTrigger!=="undefined";if(isFirefox){return true}if(!isChrome){return false}var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var fullVersion=""+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if(isChrome){verOffset=nAgt.indexOf("Chrome");fullVersion=nAgt.substring(verOffset+7)}if((ix=fullVersion.indexOf(";"))!==-1){fullVersion=fullVersion.substring(0,ix)}if((ix=fullVersion.indexOf(" "))!==-1){fullVersion=fullVersion.substring(0,ix)}majorVersion=parseInt(""+fullVersion,10);if(isNaN(majorVersion)){fullVersion=""+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10)}return majorVersion>=49}function MediaRecorderWrapper(mediaStream){var self=this;this.start=function(timeSlice,__disableLogs){this.timeSlice=timeSlice||5e3;if(!self.mimeType){self.mimeType="video/webm"}if(self.mimeType.indexOf("audio")!==-1){if(mediaStream.getVideoTracks().length&&mediaStream.getAudioTracks().length){var stream;if(!!navigator.mozGetUserMedia){stream=new MediaStream;stream.addTrack(mediaStream.getAudioTracks()[0])}else{stream=new MediaStream(mediaStream.getAudioTracks())}mediaStream=stream}}if(self.mimeType.indexOf("audio")!==-1){self.mimeType=IsChrome?"audio/webm":"audio/ogg"}self.dontFireOnDataAvailableEvent=false;var recorderHints={mimeType:self.mimeType};if(!self.disableLogs&&!__disableLogs){console.log("Passing following params over MediaRecorder API.",recorderHints)}if(mediaRecorder){mediaRecorder=null}if(IsChrome&&!isMediaRecorderCompatible()){recorderHints="video/vp8"}try{mediaRecorder=new MediaRecorder(mediaStream,recorderHints)}catch(e){mediaRecorder=new MediaRecorder(mediaStream)}if("canRecordMimeType"in mediaRecorder&&mediaRecorder.canRecordMimeType(self.mimeType)===false){if(!self.disableLogs){console.warn("MediaRecorder API seems unable to record mimeType:",self.mimeType)}}if(self.ignoreMutedMedia===true){mediaRecorder.ignoreMutedMedia=true}var firedOnDataAvailableOnce=false;mediaRecorder.ondataavailable=function(e){if(!e.data||!e.data.size||e.data.size<26800||firedOnDataAvailableOnce){return}firedOnDataAvailableOnce=true;var blob=self.getNativeBlob?e.data:new Blob([e.data],{type:self.mimeType||"video/webm"});self.ondataavailable(blob);if(!!mediaRecorder&&mediaRecorder.state==="recording"){mediaRecorder.stop()}mediaRecorder=null;if(self.dontFireOnDataAvailableEvent){return}self.start(timeSlice,"__disableLogs")};mediaRecorder.onerror=function(error){if(!self.disableLogs){if(error.name==="InvalidState"){console.error("The MediaRecorder is not in a state in which the proposed operation is allowed to be executed.")}else if(error.name==="OutOfMemory"){console.error("The UA has exhaused the available memory. User agents SHOULD provide as much additional information as possible in the message attribute.")}else if(error.name==="IllegalStreamModification"){console.error("A modification to the stream has occurred that makes it impossible to continue recording. An example would be the addition of a Track while recording is occurring. User agents SHOULD provide as much additional information as possible in the message attribute.")}else if(error.name==="OtherRecordingError"){console.error("Used for an fatal error other than those listed above. User agents SHOULD provide as much additional information as possible in the message attribute.")}else if(error.name==="GenericError"){console.error("The UA cannot provide the codec or recording option that has been requested.",error)}else{console.error("MediaRecorder Error",error)}}if(!!mediaRecorder&&mediaRecorder.state!=="inactive"&&mediaRecorder.state!=="stopped"){mediaRecorder.stop()}};try{mediaRecorder.start(36e5)}catch(e){mediaRecorder=null}setTimeout(function(){if(!mediaRecorder){return}if(mediaRecorder.state==="recording"){mediaRecorder.requestData()}},timeSlice)};this.stop=function(callback){if(!mediaRecorder){return}if(mediaRecorder.state==="recording"){mediaRecorder.requestData();setTimeout(function(){self.dontFireOnDataAvailableEvent=true;if(!!mediaRecorder&&mediaRecorder.state==="recording"){mediaRecorder.stop()}mediaRecorder=null;self.onstop()},2e3)}};this.pause=function(){if(!mediaRecorder){return}if(mediaRecorder.state==="recording"){mediaRecorder.pause()}this.dontFireOnDataAvailableEvent=true};this.ondataavailable=function(blob){console.log("recorded-blob",blob)};this.resume=function(){if(this.dontFireOnDataAvailableEvent){this.dontFireOnDataAvailableEvent=false;var disableLogs=self.disableLogs;self.disableLogs=true;this.start(this.timeslice||5e3);self.disableLogs=disableLogs;return}if(!mediaRecorder){return}if(mediaRecorder.state==="paused"){mediaRecorder.resume()}};this.clearRecordedData=function(){if(!mediaRecorder){return}this.pause();this.dontFireOnDataAvailableEvent=true;this.stop()};this.onstop=function(){};var mediaRecorder;function isMediaStreamActive(){if("active"in mediaStream){if(!mediaStream.active){return false}}else if("ended"in mediaStream){if(mediaStream.ended){return false}}return true}(function looper(){if(!mediaRecorder){return}if(isMediaStreamActive()===false){self.stop();return}setTimeout(looper,1e3)})()}if(typeof MediaStreamRecorder!=="undefined"){MediaStreamRecorder.MediaRecorderWrapper=MediaRecorderWrapper}function StereoAudioRecorder(mediaStream){this.start=function(timeSlice){timeSlice=timeSlice||1e3;mediaRecorder=new StereoAudioRecorderHelper(mediaStream,this);mediaRecorder.record();timeout=setInterval(function(){mediaRecorder.requestData()},timeSlice)};this.stop=function(){if(mediaRecorder){mediaRecorder.stop();clearTimeout(timeout);this.onstop()}};this.pause=function(){if(!mediaRecorder){return}mediaRecorder.pause()};this.resume=function(){if(!mediaRecorder){return}mediaRecorder.resume()};this.ondataavailable=function(){};this.onstop=function(){};var mediaRecorder;var timeout}if(typeof MediaStreamRecorder!=="undefined"){MediaStreamRecorder.StereoAudioRecorder=StereoAudioRecorder}function StereoAudioRecorderHelper(mediaStream,root){var deviceSampleRate=44100;if(!ObjectStore.AudioContextConstructor){ObjectStore.AudioContextConstructor=new ObjectStore.AudioContext}deviceSampleRate=ObjectStore.AudioContextConstructor.sampleRate;var leftchannel=[];var rightchannel=[];var scriptprocessornode;var recording=false;var recordingLength=0;var volume;var audioInput;var sampleRate=root.sampleRate||deviceSampleRate;var mimeType=root.mimeType||"audio/wav";var isPCM=mimeType.indexOf("audio/pcm")>-1;var context;var numChannels=root.audioChannels||2;this.record=function(){recording=true;leftchannel.length=rightchannel.length=0;recordingLength=0};this.requestData=function(){if(isPaused){return}if(recordingLength===0){requestDataInvoked=false;return}requestDataInvoked=true;var internalLeftChannel=leftchannel.slice(0);var internalRightChannel=rightchannel.slice(0);var internalRecordingLength=recordingLength;leftchannel.length=rightchannel.length=[];recordingLength=0;requestDataInvoked=false;var leftBuffer=mergeBuffers(internalLeftChannel,internalRecordingLength);var interleaved=leftBuffer;if(numChannels===2){var rightBuffer=mergeBuffers(internalRightChannel,internalRecordingLength);interleaved=interleave(leftBuffer,rightBuffer)}if(isPCM){var blob=new Blob([convertoFloat32ToInt16(interleaved)],{type:"audio/pcm"});console.debug("audio recorded blob size:",bytesToSize(blob.size));root.ondataavailable(blob);return}var buffer=new ArrayBuffer(44+interleaved.length*2);var view=new DataView(buffer);writeUTFBytes(view,0,"RIFF");view.setUint32(4,44+interleaved.length*2-8,true);writeUTFBytes(view,8,"WAVE");writeUTFBytes(view,12,"fmt ");view.setUint32(16,16,true);view.setUint16(20,1,true);view.setUint16(22,numChannels,true);view.setUint32(24,sampleRate,true);view.setUint32(28,sampleRate*numChannels*2,true);view.setUint16(32,numChannels*2,true);view.setUint16(34,16,true);writeUTFBytes(view,36,"data");view.setUint32(40,interleaved.length*2,true);var lng=interleaved.length;var index=44;var volume=1;for(var i=0;i<lng;i++){view.setInt16(index,interleaved[i]*(32767*volume),true);index+=2}var blob=new Blob([view],{type:"audio/wav"});console.debug("audio recorded blob size:",bytesToSize(blob.size));root.ondataavailable(blob)};this.stop=function(){recording=false;this.requestData();audioInput.disconnect();this.onstop()};function interleave(leftChannel,rightChannel){var length=leftChannel.length+rightChannel.length;var result=new Float32Array(length);var inputIndex=0;for(var index=0;index<length;){result[index++]=leftChannel[inputIndex];result[index++]=rightChannel[inputIndex];inputIndex++}return result}function mergeBuffers(channelBuffer,recordingLength){var result=new Float32Array(recordingLength);var offset=0;var lng=channelBuffer.length;for(var i=0;i<lng;i++){var buffer=channelBuffer[i];result.set(buffer,offset);offset+=buffer.length}return result}function writeUTFBytes(view,offset,string){var lng=string.length;for(var i=0;i<lng;i++){view.setUint8(offset+i,string.charCodeAt(i))}}function convertoFloat32ToInt16(buffer){var l=buffer.length;var buf=new Int16Array(l);while(l--){buf[l]=buffer[l]*65535}return buf.buffer}var context=ObjectStore.AudioContextConstructor;ObjectStore.VolumeGainNode=context.createGain();var volume=ObjectStore.VolumeGainNode;ObjectStore.AudioInput=context.createMediaStreamSource(mediaStream);var audioInput=ObjectStore.AudioInput;audioInput.connect(volume);var bufferSize=root.bufferSize||2048;if(root.bufferSize===0){bufferSize=0}if(context.createJavaScriptNode){scriptprocessornode=context.createJavaScriptNode(bufferSize,numChannels,numChannels)}else if(context.createScriptProcessor){scriptprocessornode=context.createScriptProcessor(bufferSize,numChannels,numChannels)}else{throw"WebAudio API has no support on this browser."}bufferSize=scriptprocessornode.bufferSize;console.debug("using audio buffer-size:",bufferSize);var requestDataInvoked=false;window.scriptprocessornode=scriptprocessornode;if(numChannels===1){console.debug("All right-channels are skipped.")}var isPaused=false;this.pause=function(){isPaused=true};this.resume=function(){isPaused=false};this.onstop=function(){};scriptprocessornode.onaudioprocess=function(e){if(!recording||requestDataInvoked||isPaused){return}var left=e.inputBuffer.getChannelData(0);leftchannel.push(new Float32Array(left));if(numChannels===2){var right=e.inputBuffer.getChannelData(1);rightchannel.push(new Float32Array(right))}recordingLength+=bufferSize};volume.connect(scriptprocessornode);scriptprocessornode.connect(context.destination)}if(typeof MediaStreamRecorder!=="undefined"){MediaStreamRecorder.StereoAudioRecorderHelper=StereoAudioRecorderHelper}function WhammyRecorder(mediaStream){this.start=function(timeSlice){timeSlice=timeSlice||1e3;mediaRecorder=new WhammyRecorderHelper(mediaStream,this);for(var prop in this){if(typeof this[prop]!=="function"){mediaRecorder[prop]=this[prop]}}mediaRecorder.record();timeout=setInterval(function(){mediaRecorder.requestData()},timeSlice)};this.stop=function(){if(mediaRecorder){mediaRecorder.stop();clearTimeout(timeout);this.onstop()}};this.onstop=function(){};this.clearOldRecordedFrames=function(){if(mediaRecorder){mediaRecorder.clearOldRecordedFrames()}};this.pause=function(){if(!mediaRecorder){return}mediaRecorder.pause()};this.resume=function(){if(!mediaRecorder){return}mediaRecorder.resume()};this.ondataavailable=function(){};var mediaRecorder;var timeout}if(typeof MediaStreamRecorder!=="undefined"){MediaStreamRecorder.WhammyRecorder=WhammyRecorder}function WhammyRecorderHelper(mediaStream,root){this.record=function(timeSlice){if(!this.width){this.width=320}if(!this.height){this.height=240}if(this.video&&this.video instanceof HTMLVideoElement){if(!this.width){this.width=video.videoWidth||video.clientWidth||320}if(!this.height){this.height=video.videoHeight||video.clientHeight||240}}if(!this.video){this.video={width:this.width,height:this.height}}if(!this.canvas||!this.canvas.width||!this.canvas.height){this.canvas={width:this.width,height:this.height}}canvas.width=this.canvas.width;canvas.height=this.canvas.height;if(this.video&&this.video instanceof HTMLVideoElement){this.isHTMLObject=true;video=this.video.cloneNode()}else{video=document.createElement("video");video.src=URL.createObjectURL(mediaStream);video.width=this.video.width;video.height=this.video.height}video.muted=true;video.play();lastTime=(new Date).getTime();whammy=new Whammy.Video(root.speed,root.quality);console.log("canvas resolutions",canvas.width,"*",canvas.height);console.log("video width/height",video.width||canvas.width,"*",video.height||canvas.height);drawFrames()};this.clearOldRecordedFrames=function(){whammy.frames=[]};var requestDataInvoked=false;this.requestData=function(){if(isPaused){return}if(!whammy.frames.length){requestDataInvoked=false;return}requestDataInvoked=true;var internalFrames=whammy.frames.slice(0);whammy.frames=dropBlackFrames(internalFrames,-1);whammy.compile(function(whammyBlob){root.ondataavailable(whammyBlob);console.debug("video recorded blob size:",bytesToSize(whammyBlob.size))});whammy.frames=[];requestDataInvoked=false};var isOnStartedDrawingNonBlankFramesInvoked=false;function drawFrames(){if(isPaused){lastTime=(new Date).getTime();setTimeout(drawFrames,500);return}if(isStopDrawing){return}if(requestDataInvoked){return setTimeout(drawFrames,100)}var duration=(new Date).getTime()-lastTime;if(!duration){return drawFrames()}lastTime=(new Date).getTime();if(!self.isHTMLObject&&video.paused){video.play()}context.drawImage(video,0,0,canvas.width,canvas.height);if(!isStopDrawing){whammy.frames.push({duration:duration,image:canvas.toDataURL("image/webp")})}if(!isOnStartedDrawingNonBlankFramesInvoked&&!isBlankFrame(whammy.frames[whammy.frames.length-1])){isOnStartedDrawingNonBlankFramesInvoked=true;root.onStartedDrawingNonBlankFrames()}setTimeout(drawFrames,10)}var isStopDrawing=false;this.stop=function(){isStopDrawing=true;this.requestData();this.onstop()};var canvas=document.createElement("canvas");var context=canvas.getContext("2d");var video;var lastTime;var whammy;var self=this;function isBlankFrame(frame,_pixTolerance,_frameTolerance){var localCanvas=document.createElement("canvas");localCanvas.width=canvas.width;localCanvas.height=canvas.height;var context2d=localCanvas.getContext("2d");var sampleColor={r:0,g:0,b:0};var maxColorDifference=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2));var pixTolerance=_pixTolerance&&_pixTolerance>=0&&_pixTolerance<=1?_pixTolerance:0;var frameTolerance=_frameTolerance&&_frameTolerance>=0&&_frameTolerance<=1?_frameTolerance:0;var matchPixCount,endPixCheck,maxPixCount;var image=new Image;image.src=frame.image;context2d.drawImage(image,0,0,canvas.width,canvas.height);var imageData=context2d.getImageData(0,0,canvas.width,canvas.height);matchPixCount=0;endPixCheck=imageData.data.length;maxPixCount=imageData.data.length/4;for(var pix=0;pix<endPixCheck;pix+=4){var currentColor={r:imageData.data[pix],g:imageData.data[pix+1],b:imageData.data[pix+2]};var colorDifference=Math.sqrt(Math.pow(currentColor.r-sampleColor.r,2)+Math.pow(currentColor.g-sampleColor.g,2)+Math.pow(currentColor.b-sampleColor.b,2));if(colorDifference<=maxColorDifference*pixTolerance){matchPixCount++}}if(maxPixCount-matchPixCount<=maxPixCount*frameTolerance){return false}else{return true}}function dropBlackFrames(_frames,_framesToCheck,_pixTolerance,_frameTolerance){var localCanvas=document.createElement("canvas");localCanvas.width=canvas.width;localCanvas.height=canvas.height;var context2d=localCanvas.getContext("2d");var resultFrames=[];var checkUntilNotBlack=_framesToCheck===-1;var endCheckFrame=_framesToCheck&&_framesToCheck>0&&_framesToCheck<=_frames.length?_framesToCheck:_frames.length;var sampleColor={r:0,g:0,b:0};var maxColorDifference=Math.sqrt(Math.pow(255,2)+Math.pow(255,2)+Math.pow(255,2))
;var pixTolerance=_pixTolerance&&_pixTolerance>=0&&_pixTolerance<=1?_pixTolerance:0;var frameTolerance=_frameTolerance&&_frameTolerance>=0&&_frameTolerance<=1?_frameTolerance:0;var doNotCheckNext=false;for(var f=0;f<endCheckFrame;f++){var matchPixCount,endPixCheck,maxPixCount;if(!doNotCheckNext){var image=new Image;image.src=_frames[f].image;context2d.drawImage(image,0,0,canvas.width,canvas.height);var imageData=context2d.getImageData(0,0,canvas.width,canvas.height);matchPixCount=0;endPixCheck=imageData.data.length;maxPixCount=imageData.data.length/4;for(var pix=0;pix<endPixCheck;pix+=4){var currentColor={r:imageData.data[pix],g:imageData.data[pix+1],b:imageData.data[pix+2]};var colorDifference=Math.sqrt(Math.pow(currentColor.r-sampleColor.r,2)+Math.pow(currentColor.g-sampleColor.g,2)+Math.pow(currentColor.b-sampleColor.b,2));if(colorDifference<=maxColorDifference*pixTolerance){matchPixCount++}}}if(!doNotCheckNext&&maxPixCount-matchPixCount<=maxPixCount*frameTolerance){}else{if(checkUntilNotBlack){doNotCheckNext=true}resultFrames.push(_frames[f])}}resultFrames=resultFrames.concat(_frames.slice(endCheckFrame));if(resultFrames.length<=0){resultFrames.push(_frames[_frames.length-1])}return resultFrames}var isPaused=false;this.pause=function(){isPaused=true};this.resume=function(){isPaused=false};this.onstop=function(){}}if(typeof MediaStreamRecorder!=="undefined"){MediaStreamRecorder.WhammyRecorderHelper=WhammyRecorderHelper}function GifRecorder(mediaStream){if(typeof GIFEncoder==="undefined"){throw"Please link: https://cdn.webrtc-experiment.com/gif-recorder.js"}this.start=function(timeSlice){timeSlice=timeSlice||1e3;var imageWidth=this.videoWidth||320;var imageHeight=this.videoHeight||240;canvas.width=video.width=imageWidth;canvas.height=video.height=imageHeight;gifEncoder=new GIFEncoder;gifEncoder.setRepeat(0);gifEncoder.setDelay(this.frameRate||this.speed||200);gifEncoder.setQuality(this.quality||1);gifEncoder.start();startTime=Date.now();function drawVideoFrame(time){if(isPaused){setTimeout(drawVideoFrame,500,time);return}lastAnimationFrame=requestAnimationFrame(drawVideoFrame);if(typeof lastFrameTime===undefined){lastFrameTime=time}if(time-lastFrameTime<90){return}if(video.paused){video.play()}context.drawImage(video,0,0,imageWidth,imageHeight);gifEncoder.addFrame(context);lastFrameTime=time}lastAnimationFrame=requestAnimationFrame(drawVideoFrame);timeout=setTimeout(doneRecording,timeSlice)};function doneRecording(){endTime=Date.now();var gifBlob=new Blob([new Uint8Array(gifEncoder.stream().bin)],{type:"image/gif"});self.ondataavailable(gifBlob);gifEncoder.stream().bin=[]}this.stop=function(){if(lastAnimationFrame){cancelAnimationFrame(lastAnimationFrame);clearTimeout(timeout);doneRecording();this.onstop()}};this.onstop=function(){};var isPaused=false;this.pause=function(){isPaused=true};this.resume=function(){isPaused=false};this.ondataavailable=function(){};this.onstop=function(){};var self=this;var canvas=document.createElement("canvas");var context=canvas.getContext("2d");var video=document.createElement("video");video.muted=true;video.autoplay=true;video.src=URL.createObjectURL(mediaStream);video.play();var lastAnimationFrame=null;var startTime,endTime,lastFrameTime;var gifEncoder;var timeout}if(typeof MediaStreamRecorder!=="undefined"){MediaStreamRecorder.GifRecorder=GifRecorder}var Whammy=function(){function WhammyVideo(duration,quality){this.frames=[];if(!duration){duration=1}this.duration=1e3/duration;this.quality=quality||.8}WhammyVideo.prototype.add=function(frame,duration){if("canvas"in frame){frame=frame.canvas}if("toDataURL"in frame){frame=frame.toDataURL("image/webp",this.quality)}if(!/^data:image\/webp;base64,/gi.test(frame)){throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp"}this.frames.push({image:frame,duration:duration||this.duration})};function processInWebWorker(_function){var blob=URL.createObjectURL(new Blob([_function.toString(),"this.onmessage =  function (e) {"+_function.name+"(e.data);}"],{type:"application/javascript"}));var worker=new Worker(blob);URL.revokeObjectURL(blob);return worker}function whammyInWebWorker(frames){function ArrayToWebM(frames){var info=checkFrames(frames);if(!info){return[]}var clusterMaxDuration=3e4;var EBML=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:doubleToString(info.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:29637},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:info.width,id:176},{data:info.height,id:186}]}]}]}]}];var frameNumber=0;var clusterTimecode=0;while(frameNumber<frames.length){var clusterFrames=[];var clusterDuration=0;do{clusterFrames.push(frames[frameNumber]);clusterDuration+=frames[frameNumber].duration;frameNumber++}while(frameNumber<frames.length&&clusterDuration<clusterMaxDuration)var clusterCounter=0;var cluster={id:524531317,data:getClusterData(clusterTimecode,clusterCounter,clusterFrames)};EBML[1].data.push(cluster);clusterTimecode+=clusterDuration}return generateEBML(EBML)}function getClusterData(clusterTimecode,clusterCounter,clusterFrames){return[{data:clusterTimecode,id:231}].concat(clusterFrames.map(function(webp){var block=makeSimpleBlock({discardable:0,frame:webp.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(clusterCounter)});clusterCounter+=webp.duration;return{data:block,id:163}}))}function checkFrames(frames){if(!frames[0]){postMessage({error:"Something went wrong. Maybe WebP format is not supported in the current browser."});return}var width=frames[0].width,height=frames[0].height,duration=frames[0].duration;for(var i=1;i<frames.length;i++){duration+=frames[i].duration}return{duration:duration,width:width,height:height}}function numToBuffer(num){var parts=[];while(num>0){parts.push(num&255);num=num>>8}return new Uint8Array(parts.reverse())}function strToBuffer(str){return new Uint8Array(str.split("").map(function(e){return e.charCodeAt(0)}))}function bitsToBuffer(bits){var data=[];var pad=bits.length%8?new Array(1+8-bits.length%8).join("0"):"";bits=pad+bits;for(var i=0;i<bits.length;i+=8){data.push(parseInt(bits.substr(i,8),2))}return new Uint8Array(data)}function generateEBML(json){var ebml=[];for(var i=0;i<json.length;i++){var data=json[i].data;if(typeof data==="object"){data=generateEBML(data)}if(typeof data==="number"){data=bitsToBuffer(data.toString(2))}if(typeof data==="string"){data=strToBuffer(data)}var len=data.size||data.byteLength||data.length;var zeroes=Math.ceil(Math.ceil(Math.log(len)/Math.log(2))/8);var sizeToString=len.toString(2);var padded=new Array(zeroes*7+7+1-sizeToString.length).join("0")+sizeToString;var size=new Array(zeroes).join("0")+"1"+padded;ebml.push(numToBuffer(json[i].id));ebml.push(bitsToBuffer(size));ebml.push(data)}return new Blob(ebml,{type:"video/webm"})}function toBinStrOld(bits){var data="";var pad=bits.length%8?new Array(1+8-bits.length%8).join("0"):"";bits=pad+bits;for(var i=0;i<bits.length;i+=8){data+=String.fromCharCode(parseInt(bits.substr(i,8),2))}return data}function makeSimpleBlock(data){var flags=0;if(data.keyframe){flags|=128}if(data.invisible){flags|=8}if(data.lacing){flags|=data.lacing<<1}if(data.discardable){flags|=1}if(data.trackNum>127){throw"TrackNumber > 127 not supported"}var out=[data.trackNum|128,data.timecode>>8,data.timecode&255,flags].map(function(e){return String.fromCharCode(e)}).join("")+data.frame;return out}function parseWebP(riff){var VP8=riff.RIFF[0].WEBP[0];var frameStart=VP8.indexOf("*");for(var i=0,c=[];i<4;i++){c[i]=VP8.charCodeAt(frameStart+3+i)}var width,height,tmp;tmp=c[1]<<8|c[0];width=tmp&16383;tmp=c[3]<<8|c[2];height=tmp&16383;return{width:width,height:height,data:VP8,riff:riff}}function getStrLength(string,offset){return parseInt(string.substr(offset+4,4).split("").map(function(i){var unpadded=i.charCodeAt(0).toString(2);return new Array(8-unpadded.length+1).join("0")+unpadded}).join(""),2)}function parseRIFF(string){var offset=0;var chunks={};while(offset<string.length){var id=string.substr(offset,4);var len=getStrLength(string,offset);var data=string.substr(offset+4+4,len);offset+=4+4+len;chunks[id]=chunks[id]||[];if(id==="RIFF"||id==="LIST"){chunks[id].push(parseRIFF(data))}else{chunks[id].push(data)}}return chunks}function doubleToString(num){return[].slice.call(new Uint8Array(new Float64Array([num]).buffer),0).map(function(e){return String.fromCharCode(e)}).reverse().join("")}var webm=new ArrayToWebM(frames.map(function(frame){var webp=parseWebP(parseRIFF(atob(frame.image.slice(23))));webp.duration=frame.duration;return webp}));postMessage(webm)}WhammyVideo.prototype.compile=function(callback){var webWorker=processInWebWorker(whammyInWebWorker);webWorker.onmessage=function(event){if(event.data.error){console.error(event.data.error);return}callback(event.data)};webWorker.postMessage(this.frames)};return{Video:WhammyVideo}}();if(typeof MediaStreamRecorder!=="undefined"){MediaStreamRecorder.Whammy=Whammy}(function(){window.ConcatenateBlobs=function(blobs,type,callback){var buffers=[];var index=0;function readAsArrayBuffer(){if(!blobs[index]){return concatenateBuffers()}var reader=new FileReader;reader.onload=function(event){buffers.push(event.target.result);index++;readAsArrayBuffer()};reader.readAsArrayBuffer(blobs[index])}readAsArrayBuffer();function concatenateBuffers(){var byteLength=0;buffers.forEach(function(buffer){byteLength+=buffer.byteLength});var tmp=new Uint16Array(byteLength);var lastOffset=0;buffers.forEach(function(buffer){var reusableByteLength=buffer.byteLength;if(reusableByteLength%2!=0){buffer=buffer.slice(0,reusableByteLength-1)}tmp.set(new Uint16Array(buffer),lastOffset);lastOffset+=reusableByteLength});var blob=new Blob([tmp.buffer],{type:type});callback(blob)}}})();if(typeof module!=="undefined"){module.exports=MediaStreamRecorder}if(typeof define==="function"&&define.amd){define("MediaStreamRecorder",[],function(){return MediaStreamRecorder})}